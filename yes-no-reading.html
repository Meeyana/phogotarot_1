<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trải Bài Tarot (1 Lá / 3 Lá)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CF1CK7N9BR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-CF1CK7N9BR');
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- CSS CHO LOADER HÀNH TINH 3D (Giữ nguyên) --- */
        .interpretation-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem; 
            overflow: hidden; 
            perspective: 800px; 
        }
        .loader-planet-system {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-style: preserve-3d;
            animation: system-wobble 15s infinite ease-in-out;
        }
        .loader-planet-sphere {
            width: 100px; 
            height: 100px; 
            border-radius: 50%;
            background-image: url('planet.png'); 
            background-size: cover; 
            background-position: center;
            background-color: transparent; 
            animation: planet-glow 2.5s infinite ease-in-out;
            position: absolute;
        }
        .loader-orbit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transform-style: preserve-3d;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }
        .orbit-1 { animation-name: orbit-spin-1; animation-duration: 3s; }
        .orbit-1::before { content: ''; position: absolute; width: 10px; height: 10px; border-radius: 50%; background: #fff; box-shadow: 0 0 15px #fff; top: 50%; left: 0; transform: translate(-50%, -50%); filter: blur(3px); }
        .orbit-2 { animation-name: orbit-spin-2; animation-duration: 5s; }
        .orbit-2::before { content: ''; position: absolute; width: 7px; height: 7px; border-radius: 50%; background: #ffc; box-shadow: 0 0 15px #ffc; top: 50%; left: 0; transform: translate(-50%, -50%); filter: blur(3px); }
        .orbit-3 { animation-name: orbit-spin-3; animation-duration: 7s; }
        .orbit-3::before { content: ''; position: absolute; width: 5px; height: 5px; border-radius: 50%; background: #fcc; box-shadow: 0 0 15px #fcc; top: 50%; left: 0; transform: translate(-50%, -50%); filter: blur(3px); }
        .orbit-4 { animation-name: orbit-spin-4; animation-duration: 10s; }
        .orbit-4::before { content: ''; position: absolute; width: 6px; height: 6px; border-radius: 50%; background: #0ff; box-shadow: 0 0 15px #0ff; top: 50%; left: 0; transform: translate(-50%, -50%); filter: blur(3px); }
        .orbit-5 { animation-name: orbit-spin-5; animation-duration: 14s; }
        .orbit-5::before { content: ''; position: absolute; width: 8px; height: 8px; border-radius: 50%; background: #f0f; box-shadow: 0 0 15px #f0f; top: 50%; left: 0; transform: translate(-50%, -50%); filter: blur(3px); }
        .loader-text {
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.8;
            text-shadow: 0 0 10px var(--text-color);
            animation: text-fade 2s infinite ease-in-out;
        }
        @keyframes system-wobble { 0% { transform: rotateY(-10deg) rotateX(5deg); } 50% { transform: rotateY(10deg) rotateX(-5deg); } 100% { transform: rotateY(-10deg) rotateX(5deg); } }
        @keyframes orbit-spin-1 { from { transform: rotateX(65deg) rotateZ(0deg); } to   { transform: rotateX(65deg) rotateZ(360deg); } }
        @keyframes orbit-spin-2 { from { transform: rotateX(65deg) rotateY(60deg) rotateZ(0deg); } to   { transform: rotateX(65deg) rotateY(60deg) rotateZ(360deg); } }
        @keyframes orbit-spin-3 { from { transform: rotateX(65deg) rotateY(-60deg) rotateZ(0deg); } to   { transform: rotateX(65deg) rotateY(-60deg) rotateZ(360deg); } }
        @keyframes orbit-spin-4 { from { transform: rotateX(65deg) rotateY(-45deg) rotateZ(0deg); } to   { transform: rotateX(65deg) rotateY(-45deg) rotateZ(360deg); } }
        @keyframes orbit-spin-5 { from { transform: rotateX(65deg) rotateY(30deg) rotateZ(0deg); } to   { transform: rotateX(65deg) rotateY(30deg) rotateZ(360deg); } }
        @keyframes text-fade { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        @keyframes planet-glow { 0% { filter: drop-shadow(0 0 5px #fff) drop-shadow(0 0 10px #8b96ff); } 50% { filter: drop-shadow(0 0 15px #fff) drop-shadow(0 0 25px #c1c8ff); } 100% { filter: drop-shadow(0 0 5px #fff) drop-shadow(0 0 10px #8b96ff); } }
        /* --- (HẾT) CSS CHO LOADER --- */
        

        /* === CSS CHO NÚT CHỌN SỐ LÁ BÀI === */
        #reading-options-container {
            width: 100%;
            max-width: 600px;
            margin: 1.5rem 0 0 0; 
            display: flex;
            background-color: var(--button-bg);
            border: 1px solid var(--card-back-border);
            border-radius: 8px;
            padding: 0.5rem;
            backdrop-filter: blur(5px);
            gap: 0.5rem; 
        }
        
        .reading-option-btn {
            flex: 1; 
            background: transparent;
            border: none;
            color: var(--text-color);
            padding: 0.75rem 1rem;
            border-radius: 6px; 
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            text-shadow: none; 
            opacity: 0.8;
        }
        
        .reading-option-btn:hover:not(.active) {
            background-color: var(--button-hover-bg);
            opacity: 1;
        }
        
        .reading-option-btn.active {
            background-color: var(--title-color); 
            color: var(--bg-color); 
            text-shadow: none;
            opacity: 1;
        }
        <!-- === (HẾT) CSS CHO NÚT CHỌN === -->

        /* === (CHỈNH SỬA) CSS CHO KHU VỰC TRA CỨU BÀI === */
        #card-lookup-container {
            width: 100%;
            max-width: 1100px; 
            margin: 2.5rem auto 0 auto; 
            background-color: var(--button-bg);
            border: 1px solid var(--card-back-border);
            border-radius: 8px;
            padding: 1.5rem;
            backdrop-filter: blur(5px);
            text-align: left; 
        }
        
        #card-lookup-container h2 {
            font-family: var(--font-title);
            color: var(--title-color);
            text-align: center; 
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        
        /* (MỚI) CSS cho wrapper thanh tìm kiếm */
        #card-search-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 1.5rem; /* Chuyển margin từ input sang wrapper */
        }
        
        /* (MỚI) CSS cho icon tìm kiếm */
        #card-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.5;
            pointer-events: none; /* Để có thể click xuyên qua icon */
            font-size: 0.9rem; /* Kích thước icon */
            text-shadow: none; /* Tắt shadow cho icon */
        }

        /* (CHỈNH SỬA) CSS cho thanh tìm kiếm tra cứu */
        #card-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.75rem; /* (CHỈNH SỬA) Tăng padding-left */
            /* margin-bottom: 1.5rem; */ /* (XÓA) Đã chuyển ra wrapper */
            background-color: var(--bg-color); /* Nền tối hơn 1 chút */
            border: 1px solid var(--card-back-border);
            border-radius: 6px;
            color: var(--text-color);
            font-family: var(--font-body);
            font-size: 0.95rem;
            text-shadow: none;
        }
        #card-search-input:focus {
            outline: none;
            border-color: var(--title-color);
            box-shadow: 0 0 10px rgba(142, 186, 255, 0.3);
        }
        #card-search-input::placeholder {
            color: var(--text-color);
            opacity: 0.5;
        }

        /* Wrapper để cuộn */
        .card-lookup-table-wrapper {
            max-height: 400px; 
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--card-back-border) var(--bg-color);
        }
        
        .card-lookup-table-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        .card-lookup-table-wrapper::-webkit-scrollbar-track {
            background: rgba(11, 19, 43, 0.5); 
            border-radius: 4px;
        }
        .card-lookup-table-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--card-back-border);
            border-radius: 4px;
            border: 2px solid rgba(11, 19, 43, 0.5);
        }
        
         @media (max-width: 768px) {
            .card-lookup-table-wrapper {
                overflow-x: auto;
            }
         }


        #card-lookup-container table {
            width: 100%;
            border-collapse: collapse;
        }
        
        @media (max-width: 768px) {
            #card-lookup-container table {
                min-width: 850px; 
            }
        }
        
        #card-lookup-container th,
        #card-lookup-container td {
            padding: 0.85rem 0.75rem; 
            border-bottom: 1px solid var(--card-back-border);
            text-shadow: none; 
            line-height: 1.5;
            font-size: 0.95rem; 
            vertical-align: middle; 
        }

        #card-lookup-container th {
            font-family: var(--font-body); 
            font-weight: 600;
            color: var(--title-color);
            position: sticky; 
            top: 0;
            background: rgb(20, 40, 80); /* Nền đặc */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1; 
        }
        
        #card-lookup-container tr:last-child td {
            border-bottom: none;
        }
        
        .lookup-card-image {
            width: 60px; 
            height: auto;
            aspect-ratio: 2/3; 
            object-fit: cover;
            border-radius: 4px;
            display: block;
            margin: 0 auto; 
        }

        /* (CHỈNH SỬA) Phân bổ lại độ rộng các cột */
        /* (CHỈNH SỬA) Ẩn cột ảnh và gộp header trên mobile */
        @media (max-width: 768px) {
            #card-lookup-container th:first-child,
            #card-lookup-container td:first-child {
                display: none; /* Ẩn cột ảnh */
            }
            
            /* Gộp header cho tên lá bài */
            #card-lookup-container th:nth-child(2) {
                /* (Nội dung này có thể không cần nếu bạn dùng colspan) */
            }
        }
        
        #card-lookup-container td:nth-child(1) { /* Cột Ảnh */
            width: 8%;
            text-align: center;
            padding: 0.5rem;
        }
        #card-lookup-container td:nth-child(2) { /* Cột Tên lá bài */
            width: 22%;
            font-weight: 600;
        }
        #card-lookup-container td:nth-child(3) { /* Cột Yes/No */
            width: 15%;
        }
        #card-lookup-container td:nth-child(4) { /* Cột Xuôi */
            width: 27.5%;
        }
        #card-lookup-container td:nth-child(5) { /* Cột Ngược */
            width: 27.5%;
        }
        /* === (HẾT) CSS TRA CỨU === */
        
    </style>
</head>
<body>

    <div id="stars-bg">
        <!-- Các ngôi sao được tạo bởi common.js -->
    </div>
    
    <!-- NAV BAR (Giữ nguyên) -->
    <nav class="main-nav">
        <div class="nav-logo">
            <a href="index.html#" class="nav-link logo-link">PHỞ GÕ TAROT</a>
        </div>
        <div class="nav-links" id="nav-links">
            <a href="index.html" class="nav-link">Trang Chủ</a>
            
            <div class="nav-item nav-dropdown">
                <div class="nav-link" id="tarot-dropdown-toggle" style="cursor: pointer;">
                    <span>Bói tarot</span>
                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="dropdown-submenu">
                    <a href="tarot.html" class="nav-link submenu-link">Trải bài 3 lá</a> 
                    <a href="yes-no-reading.html" class="nav-link submenu-link">Yes/No Question</a>
                    <a href="#" class="nav-link submenu-link">Zodiac Tarot</a>
                </div>
            </div>
            <a href="index.html#" class="nav-link">Về chúng tôi</a>
            <a href="index.html#" class="nav-link">Blogs</a>
            <a href="index.html#" class="nav-link">Đặt lịch</a>
            <a href="index.html#" class="nav-link">Liên hệ</a>
            <a href="#" id="history-nav-link" class="nav-link">Lịch sử</a>
        </div>
        <button class="nav-toggle" id="nav-toggle" aria-label="toggle navigation">
            <span class="hamburger"></span>
        </button>
    </nav>


    <!-- MÀN HÌNH 1: CÂU HỎI -->
    <div id="question-screen" class="screen active">
        <h1 class="title">Bạn muốn hỏi điều gì?</h1>
        
        <div id="question-input-area" class="question-input-area">
            <textarea id="question-input" class="question-input" placeholder="Viết câu hỏi của bạn ở đây..." style="min-height: 56px;"></textarea>
            <button id="submit-question-btn" title="Gửi câu hỏi">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
        
        <!-- (CHỈNH SỬA) Đảo vị trí nút và đổi 'active' -->
        <div id="reading-options-container">
            <button class="reading-option-btn active" data-value="1">
                Chọn 1 lá (Hỏi nhanh)
            </button>
            <button class="reading-option-btn" data-value="3">
                Chọn 3 lá (Tổng quan)
            </button>
        </div>

        <div class="dropdown-container">
            <button id="suggested-questions-toggle" class="dropdown-toggle">
                <span>Gợi ý câu hỏi</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16" style="transition: transform 0.2s;">
                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="suggested-questions-list" class="dropdown-menu">
                <p style="padding: 1rem; opacity: 0.7; text-align: center;">Đang tải gợi ý...</p>
            </div>
        </div>
        
        <p id="question-error-display" style="min-height: 1.2em; font-weight: 600;"></p>

        <!-- === (ĐÃ DI CHUYỂN) KHU VỰC TRA CỨU BÀI đã được chuyển sang #drawing-screen === -->
        <!-- <div id="card-lookup-container"> ... </div> -->

    </div>

    <!-- MÀN HÌNH 2: XÁO BÀI (Giữ nguyên) -->
    <div id="shuffling-screen" class="screen">
        <div id="shuffling-question-display" class="question-display-header"></div>
        <div class="shuffling-animation-container">
            <div class="shuffle-card"></div>
            <div class="shuffle-card"></div>
            <div class="shuffle-card"></div>
        </div>
        <p class="shuffling-instruction">
            Hãy giữ tập trung vào câu hỏi của bạn.
            <br>
            Để có kết quả tốt nhất, bạn không nên làm việc riêng trong lúc này.
        </p>
    </div>

    <!-- MÀN HÌNH 3: CHỌN BÀI (Giữ nguyên) -->
    <div id="drawing-screen" class="screen">
        <div id="drawing-question-display" class="question-display-header"></div>
        
        <h2 class="drawing-subheader">Hãy chọn 3 lá bài</h2>
        
        <div id="chosen-cards-display">
            <div class="chosen-card-placeholder"></div>
            <div class="chosen-card-placeholder"></div>
            <div class="chosen-card-placeholder"></div>
        </div>
        
        <div id="card-spread-container">
            <div class="card-row" id="card-row-1"></div>
            <div class="card-row" id="card-row-2"></div>
            <div class="card-row mobile-row" id="card-row-3"></div>
            <div class="card-row mobile-row" id="card-row-4"></div>
            <div class="card-row mobile-row" id="card-row-5"></div>
            <div class="card-row mobile-row" id="card-row-6"></div>
        </div>
        
        <div id="action-button-container">
            <button id="get-interpretation-button" class="action-button">Xem ý nghĩa</button>
        </div>
        
        <div id="interpretation-results-display"></div>
        
        <div id="follow-up-question-container">
            <h3>Bạn có câu hỏi nào khác không?</h3>
            <div id="follow-up-input-area" class="question-input-area">
                <textarea id="follow-up-question-input" class="question-input" placeholder="Đặt câu hỏi tiếp theo..." style="min-height: 56px;"></textarea>
                <button id="submit-follow-up-btn" title="Gửi câu hỏi mới">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>
                </button>
            </div>
            <p id="follow-up-error-display" style="min-height: 1.2em; font-weight: 600;"></p>
        </div>

        <!-- === (ĐÃ DI CHUYỂN) KHU VỰC TRA CỨU BÀI === -->
        <!-- (CHỈNH SỬA) Bảng tra cứu được chuyển xuống đây, ẩn mặc định -->
        <div id="card-lookup-container" style="display: none;">
            <h2>Tra cứu nhanh ý nghĩa lá bài</h2>
            
            <div id="card-search-wrapper">
                <i class="fa-solid fa-search" id="card-search-icon"></i>
                <input type="text" id="card-search-input" placeholder="Gõ tên lá bài (ít nhất 3 ký tự) để lọc...">
            </div>
            
            <div id="card-lookup-table">
                <!-- Nội dung sẽ được tải bằng JS -->
                <p style="padding: 1rem; opacity: 0.7; text-align: center;">Đang tải dữ liệu tra cứu...</p>
            </div>
        </div>
        <!-- === (HẾT) KHU VỰC TRA CỨU BÀI === -->

    </div>
    
    <!-- MODAL LỊCH SỬ (Giữ nguyên) -->
    <div id="history-modal-backdrop" class="modal-backdrop"></div>
    <div id="history-modal-content" class="modal-content">
        <div class="modal-header">
            <button id="history-modal-close-btn" class="modal-close-btn">&times;</button>
            <h2>Lịch sử trải bài</h2>
        </div>
        <div id="history-list-wrapper" class="modal-scroll-wrapper">
            <div id="history-list">
                <!-- Nội dung được tạo bởi common.js -->
            </div>
        </div>
    </div>

    <!-- FOOTER (Giữ nguyên) -->
    <footer class="main-footer">
            <div class="footer-container">
                <div class="footer-column brand">
                    <a href="index.html" class="footer-logo">Phở Gõ Tarot</a>
                    <p class="footer-description">
                        Tarot không phải là công cụ dự đoán tương lai, mà là cung cấp những gợi ý và suy nghĩ để bạn tự khám phá và quyết định con đường của mình.
                    </p>
                    <div class="footer-social-links">
                        <a href="#" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
                        <a href="#" target="_blank" rel="noopener noreferrer" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
                        <a href="https://www.instagram.com/pho_go_tarot/" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
                        <a href="#" target="_blank" rel="noopener noreferrer" aria-label="TikTok"><i class="fa-brands fa-tiktok"></i></a>
                    </div>
                </div>
                <div class="footer-column links">
                    <h3 class="footer-title">Chính sách</h3>
                    <ul class="footer-link-list">
                        <li><a href="index.html#about">Giới thiệu</a></li>
                        <li><a href="index.html#contact">Liên hệ</a></li>
                        <li><a href="#">Chính sách bảo mật</a></li>
                        <li><a href="#">Miễn trừ trách nhiệm</a></li>
                    </ul>
                </div>
                <div class="footer-column contact">
                    <h3 class="footer-title">Thông tin liên hệ</h3>
                    <ul class="footer-link-list">
                        <li><i class="fa-solid fa-location-dot"></i><span>Quận Bình Thạnh, Hồ Chí Minh, VN</span></li>
                        <li><i class="fa-solid fa-phone"></i><a href="tel:0931881420">0352 677 543</a></li>
                        <li><i class="fa-solid fa-envelope"></i><a href="mailto:tarotmienphi@gmail.com">bebluetotrue@gmail.com</a></li>
                        <li><i class="fa-solid fa-globe"></i><a href="https://tarotmienphi.com" target="_blank" rel="noopener noreferrer">https://phogotarot.com</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-copyright">
                &copy; 2025 Phở Gõ Tarot. Mọi quyền được bảo lưu.
            </div>
        </footer>

    <!-- (QUAN TRỌNG) Tải common.js trước logic của trang -->
    <script src="common.js" defer></script>


    <!-- SCRIPT LOGIC CỦA TRANG (ĐÃ CHỈNH SỬA) -->
    <script>
/* ============================================= */
/* === TAROT.JS (Logic cho trang 1/3 lá) === */
/* ============================================= */

const N8N_WEBHOOK_URL = 'https://n8n.n8ntuanphangz.xyz/webhook/29fa6319-ca20-42a6-9d31-5a599e1a030d'; 
const N8N_VALIDATE_URL = 'https://n8n.n8ntuanphangz.xyz/webhook/2b074c1e-6465-4114-872d-c0dcd9278b62'; 
const SHEET_ID = '1Bqu2RBPRH-YeCOiX_5SjmQP8GETpKkqBZhMPZwqm_ig';

// DOM Elements
const screens = document.querySelectorAll('.screen');
const questionInput = document.getElementById('question-input');
const submitQuestionBtn = document.getElementById('submit-question-btn');
const questionErrorDisplay = document.getElementById('question-error-display'); 
const cardLookupTable = document.getElementById('card-lookup-table'); 
const suggestedQuestionsToggle = document.getElementById('suggested-questions-toggle');
const suggestedQuestionsList = document.getElementById('suggested-questions-list');
const readingOptionBtns = document.querySelectorAll('.reading-option-btn');
const cardRow1 = document.getElementById('card-row-1');
const cardRow2 = document.getElementById('card-row-2');
const cardRow3 = document.getElementById('card-row-3'); 
const cardRow4 = document.getElementById('card-row-4');
const cardRow5 = document.getElementById('card-row-5');
const cardRow6 = document.getElementById('card-row-6');
const chosenCardsDisplay = document.getElementById('chosen-cards-display'); 
const shufflingQuestionDisplay = document.getElementById('shuffling-question-display');
const drawingQuestionDisplay = document.getElementById('drawing-question-display');
const drawingSubheader = document.querySelector('.drawing-subheader'); 
const getInterpretationButton = document.getElementById('get-interpretation-button');
const mainResultsDisplay = document.getElementById('interpretation-results-display');
const followUpContainer = document.getElementById('follow-up-question-container');
const followUpInput = document.getElementById('follow-up-question-input');
const followUpSubmitBtn = document.getElementById('submit-follow-up-btn');
const followUpErrorDisplay = document.getElementById('follow-up-error-display'); 

// Icon HTML
const sendIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
</svg>`;
const spinnerIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-spin" width="20" height="20">
    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
</svg>`;

// State
let cardData = [];
let selectedCards = [];
let userQuestion = '';
let isAnimating = false; 
let allCardImagesLoaded = false;
let currentReadingId = null; 
let numCardsToChoose = 1; // (CHỈNH SỬA) Đổi mặc định sang 1 lá

// === Functions ===

/** Auto-grow textarea */
function autoGrow(element) {
    if (!element) return;
    element.style.height = 'auto'; 
    element.style.height = Math.max(56, element.scrollHeight) + 'px'; 
}

/** Chuyển màn hình */
function showScreen(screenId) {
    screens.forEach(screen => screen.classList.remove('active'));
    const activeScreen = document.getElementById(screenId);
    if (activeScreen) {
        activeScreen.classList.add('active');
    }
}

/** Tải dữ liệu 78 lá bài */
async function initialize() {
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Cards&tqx=out:json&tq=SELECT%20*%20OFFSET%201`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const table = JSON.parse(jsonText).table;

        cardData = table.rows.map((row, index) => ({
            id: index,
            name: row.c[0]?.v || 'Unknown Card',
            image: row.c[1]?.v || 'https://placehold.co/200x340'
        }));

        preloadAllCardImages();
    } catch (error)
    {
        console.error("Lỗi khi tải lá bài:", error);
        if (document.getElementById('card-spread-container')) {
             document.getElementById('card-spread-container').innerHTML = '<p>Lỗi tải bộ bài. Vui lòng tải lại trang.</p>';
        }
    }
}

/** (CHỈNH SỬA) Tải dữ liệu tra cứu (gộp header) */
async function loadCardMeanings() {
    if (!cardLookupTable) return; 
    
    cardLookupTable.innerHTML = '<p style="padding: 1rem; opacity: 0.7; text-align: center;">Đang tải dữ liệu tra cứu...</p>';

    try {
        const sheetName = 'YesNo_Meaning'; 
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheetName}&tqx=out:json&tq=SELECT%20A,%20B,%20C,%20D,%20E%20OFFSET%201`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}. Lỗi khi tải tab '${sheetName}'.`);
        
        const text = await response.text();
        
        if (text.startsWith('<!DOCTYPE html>')) {
            throw new Error(`Không tìm thấy tab '${sheetName}' hoặc lỗi truy cập Google Sheet.`);
        }
        
        const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const data = JSON.parse(jsonText);

        if (data.status === 'error') {
            let errorMsg = data.errors.map(e => e.detailed_message).join(', ');
            if (errorMsg.includes('Unable to parse query') || errorMsg.includes('Invalid sheet')) {
                 throw new Error(`Lỗi GVIZ: Không tìm thấy tab tên là '${sheetName}'. Vui lòng kiểm tra lại tên tab trong Google Sheet.`);
            }
             if (errorMsg.includes('SELECT_E')) {
                 throw new Error(`Lỗi GVIZ: Không tìm thấy Cột E trong tab '${sheetName}'. Vui lòng thêm cột E chứa URL hình ảnh.`);
            }
            throw new Error(`Lỗi GVIZ: ${errorMsg}`);
        }

        const table = data.table;
        const rows = table.rows;

        if (rows.length === 0) {
            cardLookupTable.innerHTML = '<p style="padding: 1rem; opacity: 0.7; text-align: center;">Không có dữ liệu tra cứu.</p>';
            return;
        }

        let html = '<div class="card-lookup-table-wrapper"><table>'; 
        html += `
            <thead>
                <tr>
                    <!-- (CHỈNH SỬA) Gộp 2 cột đầu tiên -->
                    <th colspan="2">Lá bài Tarot</th> 
                    <th>Ý nghĩa Yes/No</th>
                    <th>Ý nghĩa Xuôi</th>
                    <th>Ý nghĩa Ngược</th>
                </tr>
            </thead>
            <tbody>
        `; // <tbody> được thêm ở đây

        rows.forEach(row => {
            const cardName = row.c[0]?.v || 'N/A';
            const yesNo = row.c[1]?.v || 'N/A';
            const upright = row.c[2]?.v || 'N/A';
            const reversed = row.c[3]?.v || 'N/A';
            const imageUrl = row.c[4]?.v || 'https://placehold.co/60x100?text=?'; 
            
            html += `
                <tr>
                    <td><img src="${imageUrl}" alt="${cardName}" class="lookup-card-image" loading="lazy"></td>
                    <td><strong>${cardName}</strong></td>
                    <td>${yesNo}</td>
                    <td>${upright}</td>
                    <td>${reversed}</td>
                </tr>
            `;
        });

        html += '</tbody></table></div>'; // Đóng </tbody>, <table>, <div>
        cardLookupTable.innerHTML = html;

    } catch (error) {
        console.error("Lỗi khi tải dữ liệu tra cứu bài:", error);
        cardLookupTable.innerHTML = `<p style="padding: 1rem; opacity: 0.7; text-align: center; color: #ff8a8a;">Lỗi tải dữ liệu tra cứu: ${error.message}<br>Vui lòng đảm bảo Google Sheet có một tab tên là 'Meanings' (đã thêm Cột E) và đã được chia sẻ công khai.</p>`;
    }
}

/** (MỚI) Hàm lọc bảng tra cứu */
function filterCardTable() {
    const searchInput = document.getElementById('card-search-input');
    if (!searchInput) return;
    
    // 1. Lấy cụm từ tìm kiếm (chuyển về chữ thường, bỏ khoảng trắng thừa)
    const searchTerm = searchInput.value.toLowerCase().trim();
    // 2. Tìm tất cả các hàng <tr> trong <tbody>
    const tableRows = document.querySelectorAll('#card-lookup-table tbody tr');

    // 3. Kiểm tra điều kiện (ít nhất 3 ký tự)
    if (searchTerm.length >= 3) {
        // 4. Lặp qua từng hàng
        tableRows.forEach(row => {
            // Cột Tên lá bài là cột thứ 2 (td:nth-child(2))
            const cardNameCell = row.querySelector('td:nth-child(2)'); 
            if (cardNameCell) {
                const cardName = cardNameCell.textContent.toLowerCase();
                
                // 5. So sánh: Nếu tên lá bài CHỨA cụm từ tìm kiếm
                if (cardName.includes(searchTerm)) {
                    row.style.display = ""; // Hiện hàng này
                } else {
                    row.style.display = "none"; // Ẩn hàng này
                }
            }
        });
    } else {
        // 6. Nếu dưới 3 ký tự, hiện tất cả các hàng
        tableRows.forEach(row => {
            row.style.display = "";
        });
    }
}


/** Tải câu hỏi gợi ý */
async function loadSuggestedQuestions() {
    if (!suggestedQuestionsList) return; 
    
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=YnQuestions&tqx=out:json&tq=SELECT%20A,%20B%20OFFSET%201`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const table = JSON.parse(jsonText).table;

        const rawData = table.rows.map(row => ({
            category: row.c[0]?.v,
            question: row.c[1]?.v
        }));

        const grouped = {};
        rawData.forEach(item => {
            if (!item.category || !item.question) return; 
            if (!grouped[item.category]) {
                grouped[item.category] = [];
            }
            grouped[item.category].push(item.question);
        });
        
        renderSuggestedQuestions(grouped);

    } catch (error) {
        console.error("Lỗi khi tải câu hỏi gợi ý:", error);
        suggestedQuestionsList.innerHTML = '<p style="padding: 1rem; opacity: 0.7; text-align: center;">Không thể tải gợi ý.</p>';
    }
}

/** Hiển thị câu hỏi gợi ý */
function renderSuggestedQuestions(groupedData) {
    if (!suggestedQuestionsList) return;
    let html = '';
    for (const category in groupedData) {
        html += `<h4 class="category-title">${category}</h4>`;
        groupedData[category].forEach(question => {
            const safeQuestion = question.replace(/"/g, '&quot;');
            html += `<button class="suggestion-item" data-question="${safeQuestion}">${question}</button>`;
        });
    }
    suggestedQuestionsList.innerHTML = html;
}

/** Tải trước hình ảnh 78 lá bài */
function preloadAllCardImages() {
    if (!cardData || cardData.length === 0) return;

    console.log("Bắt đầu tải trước 78 hình ảnh lá bài...");
    const imagePromises = cardData.map(card => {
        return new Promise((resolve) => { 
            const img = new Image();
            img.src = card.image;
            img.onload = resolve;
            img.onerror = resolve; 
        });
    });

    Promise.all(imagePromises)
        .then(() => {
            allCardImagesLoaded = true;
            console.log("Tất cả 78 hình ảnh lá bài đã được tải trước!");
        })
        .catch(err => {
            console.error("Lỗi trong quá trình tải trước hình ảnh:", err);
            allCardImagesLoaded = true; 
        });
}

/** Xử lý khi nộp câu hỏi đầu tiên */
async function handleQuestionSubmit() {
    const questionFromInput = questionInput.value.trim();
    questionErrorDisplay.textContent = ''; 
    questionErrorDisplay.style.color = '#ff8a8a'; 

    if (!questionFromInput) {
        const inputArea = document.getElementById('question-input-area');
        inputArea.style.animation = 'shake 0.5s ease';
        setTimeout(() => { inputArea.style.animation = ''; }, 500);
        return;
    }
    
    submitQuestionBtn.disabled = true;
    submitQuestionBtn.innerHTML = spinnerIcon;
    questionErrorDisplay.textContent = 'Đang kiểm tra câu hỏi của bạn...'; 
    questionErrorDisplay.style.color = '#d4af37'; 
    
    try {
        const response = await fetch(N8N_VALIDATE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: questionFromInput })
        });

        if (N8N_VALIDATE_URL.includes('YOUR-VALIDATION-WEBHOOK-ID')) {
             throw new Error('Vui lòng thay thế URL N8N_VALIDATE_URL');
        }
        
        if (!response.ok) {
            throw new Error('Lỗi từ máy chủ xác thực.');
        }

        const n8nResponse = await response.json();
        const validationResult = n8nResponse;

        if (validationResult && (validationResult.isValid === "true" || validationResult.isValid === true)) {
            userQuestion = questionFromInput;
            currentReadingId = crypto.randomUUID(); 
            startNewReadingFlow();
            submitQuestionBtn.disabled = false;
            submitQuestionBtn.innerHTML = sendIcon;
        } else {
            questionErrorDisplay.textContent = validationResult?.reason || 'Câu hỏi không hợp lệ.';
            questionErrorDisplay.style.color = '#ff8a8a'; 
            submitQuestionBtn.disabled = false;
            submitQuestionBtn.innerHTML = sendIcon;
        }

    } catch (error) {
        console.error("Lỗi khi xác thực câu hỏi:", error);
        if (error.message.includes('URL')) {
            questionErrorDisplay.textContent = 'Lỗi: Bạn chưa cập nhật N8N_VALIDATE_URL trong code.';
        } else {
            questionErrorDisplay.textContent = 'Không thể kết nối máy chủ. Vui lòng thử lại.';
        }
        questionErrorDisplay.style.color = '#ff8a8a'; 
        submitQuestionBtn.disabled = false;
        submitQuestionBtn.innerHTML = sendIcon;
    }
}

/** Xử lý khi nộp câu hỏi tiếp theo */
async function handleFollowUpSubmit() {
    const questionFromInput = followUpInput.value.trim();
    followUpErrorDisplay.textContent = ''; 
    followUpErrorDisplay.style.color = '#ff8a8a'; 

    if (!questionFromInput) {
        const inputArea = document.getElementById('follow-up-input-area');
        inputArea.style.animation = 'shake 0.5s ease';
        setTimeout(() => { inputArea.style.animation = ''; }, 500);
        return;
    }
    
    followUpSubmitBtn.disabled = true;
    followUpSubmitBtn.innerHTML = spinnerIcon;
    followUpErrorDisplay.textContent = 'Đang kiểm tra câu hỏi của bạn...'; 
    followUpErrorDisplay.style.color = '#d4af37'; 

    try {
        const response = await fetch(N8N_VALIDATE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: questionFromInput })
        });

        if (N8N_VALIDATE_URL.includes('YOUR-VALIDATION-WEBHOOK-ID')) {
             throw new Error('Vui lòng thay thế URL N8N_VALIDATE_URL');
        }

        if (!response.ok) {
            throw new Error('Lỗi từ máy chủ xác thực.');
        }

        const n8nResponse = await response.json();
        const validationResult = n8nResponse;

        if (validationResult && (validationResult.isValid === "true" || validationResult.isValid === true)) {
            userQuestion = questionFromInput;
            followUpInput.value = '';
            currentReadingId = crypto.randomUUID(); 
            startNewReadingFlow();
            followUpSubmitBtn.disabled = false;
            followUpSubmitBtn.innerHTML = sendIcon;
        } else {
            followUpErrorDisplay.textContent = validationResult?.reason || 'Câu hỏi không hợp lệ.';
            followUpErrorDisplay.style.color = '#ff8a8a'; 
            followUpSubmitBtn.disabled = false;
            followUpSubmitBtn.innerHTML = sendIcon;
        }

    } catch (error) {
        console.error("Lỗi khi xác thực câu hỏi (hỏi tiếp):", error);
        if (error.message.includes('URL')) {
            followUpErrorDisplay.textContent = 'Lỗi: Bạn chưa cập nhật N8N_VALIDATE_URL trong code.';
        } else {
            followUpErrorDisplay.textContent = 'Không thể kết nối máy chủ. Vui lòng thử lại.';
        }
        followUpErrorDisplay.style.color = '#ff8a8a'; 
        followUpSubmitBtn.disabled = false;
        followUpSubmitBtn.innerHTML = sendIcon;
    }
}

/** Tiêm CSS cho hiệu ứng rung lắc */
const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = `@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }`;
document.head.appendChild(styleSheet);


/** Bắt đầu một lượt trải bài mới */
function startNewReadingFlow() {
    sessionStorage.removeItem('tarotSession'); 
    
    shufflingQuestionDisplay.textContent = userQuestion;
    drawingQuestionDisplay.textContent = userQuestion;
    showScreen('shuffling-screen');

    const shuffleTime = 2500; 
    const startTime = Date.now();

    function checkAndProceed() {
        const elapsedTime = Date.now() - startTime;
        const timeRemaining = shuffleTime - elapsedTime;

        if (allCardImagesLoaded && timeRemaining <= 0) {
            populateCardDeck();
            showScreen('drawing-screen');
        } else {
            const nextCheck = allCardImagesLoaded ? timeRemaining : 100;
            setTimeout(checkAndProceed, Math.max(nextCheck, 0)); 
        }
    }

    checkAndProceed();
}

/** Tạo bộ bài 78 lá úp */
function populateCardDeck() {
    cardRow1.innerHTML = '';
    cardRow2.innerHTML = '';
    cardRow3.innerHTML = '';
    cardRow4.innerHTML = '';
    cardRow5.innerHTML = '';
    cardRow6.innerHTML = '';
    selectedCards = []; 
    mainResultsDisplay.style.display = 'none';
    mainResultsDisplay.innerHTML = '';

    if (drawingSubheader) {
        drawingSubheader.textContent = `Hãy chọn ${numCardsToChoose} lá bài`;
    }
    updateChosenCardsDisplay(); 

    const drawingScreen = document.getElementById('drawing-screen');
    drawingScreen.classList.remove('results-active');
    
    getInterpretationButton.classList.remove('visible');
    getInterpretationButton.style.display = 'none';
    
    followUpContainer.style.display = 'none';
    followUpInput.value = '';
    followUpErrorDisplay.textContent = ''; 
    questionInput.value = ''; 

    // (MỚI) Ẩn bảng tra cứu khi bắt đầu vòng mới
    const lookupContainer = document.getElementById('card-lookup-container');
    if (lookupContainer) {
        lookupContainer.style.display = 'none';
    }

    // Tạo 78 lá bài
    for (let i = 0; i < 78; i++) {
        const cardElementDesktop = document.createElement('div');
        cardElementDesktop.className = 'facedown-card';
        cardElementDesktop.dataset.positionIndex = i;
        cardElementDesktop.style.animation = `dealCardIn 0.3s ease-out forwards ${i * 30}ms`;
        
        const cardElementMobile = cardElementDesktop.cloneNode(true);
        
        const animationEndCallback = (e) => {
            if (e.animationName === 'dealCardIn') {
                e.target.classList.add('is-dealt'); 
                e.target.style.animation = ''; 
            }
        };
        cardElementDesktop.addEventListener('animationend', animationEndCallback);
        cardElementMobile.addEventListener('animationend', animationEndCallback);
        
        const clickHandler = (e) => handleCardSelection(e, e.currentTarget);
        cardElementDesktop.addEventListener('click', clickHandler);
        cardElementMobile.addEventListener('click', clickHandler);
        
        cardElementDesktop.addEventListener('touchstart', clickHandler);
        cardElementMobile.addEventListener('touchstart', clickHandler);

        if (i < 39) {
            cardRow1.appendChild(cardElementDesktop);
        } else {
            cardRow2.appendChild(cardElementDesktop);
        }
        
        if (i < 20) {
            cardRow3.appendChild(cardElementMobile);
        } else if (i < 40) {
            cardRow4.appendChild(cardElementMobile);
        } else if (i < 60) {
            cardRow5.appendChild(cardElementMobile);
        } else {
            cardRow6.appendChild(cardElementMobile);
        }
    }
}

/** Xử lý khi người dùng chọn 1 lá bài */
function handleCardSelection(event, clickedElement) {
    event.preventDefault();
    
    if (selectedCards.length >= numCardsToChoose || isAnimating) return; 

    const posIndex = clickedElement.dataset.positionIndex;
    const allCardsWithIndex = document.querySelectorAll(`.facedown-card[data-position-index="${posIndex}"]`);

    let alreadyChosen = false;
    allCardsWithIndex.forEach(card => {
        if (card.classList.contains('is-chosen')) {
            alreadyChosen = true;
        }
    });
    if (alreadyChosen) return;

    isAnimating = true; 

    allCardsWithIndex.forEach(card => card.classList.add('is-chosen'));

    const availableCards = cardData.filter(card => !selectedCards.some(sc => sc.id === card.id));
    const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
    const isReversed = Math.random() < 0.5;
    const orientation = isReversed ? 'Ngược' : 'Xuôi';
    const chosenCard = { ...randomCard, isReversed, orientation };

    const targetPlaceholder = document.querySelectorAll('#chosen-cards-display .chosen-card-placeholder')[0];
    
    if (targetPlaceholder) {
        animateCardFlight(clickedElement, targetPlaceholder, chosenCard);
    } else {
        isAnimating = false;
    }
}

/** Hiệu ứng lá bài bay */
function animateCardFlight(startEl, endEl, cardData) {
    
    const img = new Image();
    
    const onImageLoaded = () => {
        const startRect = startEl.getBoundingClientRect();
        const endRect = endEl.getBoundingClientRect();
        
        const flyingCard = document.createElement('div');
        flyingCard.className = 'flying-card-animator';
        
        const reversedClass = cardData.isReversed ? 'reversed' : '';
        flyingCard.innerHTML = `
            <div class="flying-card-inner">
                <div class="flying-card-back"></div>
                <div class="flying-card-front">
                    <img src="${cardData.image}" alt="${cardData.name}" class="${reversedClass}">
                </div>
            </div>
        `;
        
        flyingCard.style.top = `${startRect.top + window.scrollY}px`;
        flyingCard.style.left = `${startRect.left}px`;
        flyingCard.style.width = `${startRect.width}px`;
        flyingCard.style.height = `${startRect.height}px`;
        
        document.body.appendChild(flyingCard);
        
        requestAnimationFrame(() => {
            const inner = flyingCard.querySelector('.flying-card-inner');
            
            flyingCard.style.top = `${endRect.top + window.scrollY}px`;
            flyingCard.style.left = `${endRect.left}px`;
            flyingCard.style.width = `${endRect.width}px`;
            flyingCard.style.height = `${endRect.height}px`;
            
            inner.style.transform = 'rotateY(180deg) translateZ(0)';
        });

        let flightHasEnded = false;
        
        const onFlightEnd = (event) => {
            if (event.target !== flyingCard || flightHasEnded) {
                return;
            }
            flightHasEnded = true; 

            flyingCard.removeEventListener('transitionend', onFlightEnd);
            flyingCard.remove(); 
            
            selectedCards.push(cardData);
            updateChosenCardsDisplay(); 

            if (selectedCards.length === numCardsToChoose) {
                transitionToResultsView(); 
            }
            
            isAnimating = false; 
        };
        
        flyingCard.addEventListener('transitionend', onFlightEnd);
    };

    img.onload = onImageLoaded; 
    img.onerror = onImageLoaded; 
    img.src = cardData.image; 
}


/** Cập nhật khu vực các lá bài đã chọn */
function updateChosenCardsDisplay() {
    chosenCardsDisplay.innerHTML = '';
    let cardItemElements = []; 
    
    selectedCards.forEach(card => {
        const cardItem = document.createElement('div');
        cardItem.className = 'chosen-card-item';
        cardItem.innerHTML = `
            <div class="card-image-wrapper">
                <img src="${card.image}" alt="${card.name}" class="${card.isReversed ? 'reversed' : ''}">
            </div>
            <div class="card-info">
                <div class="card-name">${card.name}</div>
                ${card.isReversed ? '<div class="card-orientation">(Lá bài Ngược)</div>' : ''}
            </div>
        `;
        cardItemElements.push(cardItem); 
    });
    
    cardItemElements.forEach(item => {
        chosenCardsDisplay.appendChild(item);
        setTimeout(() => {
            item.style.opacity = '1';
        }, 0);
    });

    for (let i = 0; i < numCardsToChoose - selectedCards.length; i++) {
        chosenCardsDisplay.innerHTML += '<div class="chosen-card-placeholder"></div>';
    }
}

/** Chuyển sang trạng thái xem kết quả */
function transitionToResultsView() {
    const drawingScreen = document.getElementById('drawing-screen');
    drawingScreen.classList.add('results-active');
    
    getInterpretationButton.style.display = 'inline-block'; 
    setTimeout(() => {
        getInterpretationButton.classList.add('visible');
    }, 300); 
}

/** Lấy luận giải từ AI */
async function handleGetInterpretation() {
    mainResultsDisplay.style.display = 'block';
    
    mainResultsDisplay.innerHTML = `
        <div class="interpretation-loader">
            <div class="loader-planet-system">
                <div class="loader-planet-sphere"></div>
                <div class="loader-orbit orbit-1"></div>
                <div class="loader-orbit orbit-2"></div>
                <div class="loader-orbit orbit-3"></div>
                <div class="loader-orbit orbit-4"></div>
                <div class="loader-orbit orbit-5"></div>
            </div>
            <p class="loader-text">Đang luận giải, vũ trụ đang trả lời...</p>
        </div>
    `;

    getInterpretationButton.classList.remove('visible');
    setTimeout(() => {
        getInterpretationButton.style.display = 'none';
    }, 300);
    
    const payload = {
        question: userQuestion,
        cards: selectedCards.map(c => ({ name: c.name, orientation: c.orientation })),
        readingId: currentReadingId 
    };

    try {
        const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`Lỗi từ server: ${response.statusText}`);

        const result = await response.json(); 
        
        if (result && result.interpretation) {
            const converter = new showdown.Converter();
            const markdownContent = result.interpretation; 
            const htmlContent = converter.makeHtml(markdownContent);
            mainResultsDisplay.innerHTML = htmlContent; 

            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = htmlContent;
            const plainTextContent = (tempDiv.textContent || tempDiv.innerText || "").trim();

            const fullEntry = { 
                readingId: currentReadingId, 
                timestamp: Date.now(), 
                question: userQuestion, 
                cards: selectedCards, 
                html: htmlContent, 
                text: plainTextContent, 
                markdown: markdownContent 
            };

            if (typeof saveHistory === 'function') {
                saveHistory(fullEntry);
            } else {
                console.error("Lỗi: Không tìm thấy hàm saveHistory().");
            }

        } else {
            throw new Error("Dữ liệu trả về không đúng định dạng.");
        }
    } catch (error) {
        console.error("Lỗi khi gọi Webhook:", error);
        mainResultsDisplay.innerHTML = `<p>Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại sau.</p>`;
    }
    
    mainResultsDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
    followUpContainer.style.display = 'block';

    // (MỚI) Hiển thị bảng tra cứu cùng lúc với nút "hỏi tiếp"
    const lookupContainer = document.getElementById('card-lookup-container');
    if (lookupContainer) {
        lookupContainer.style.display = 'block';
    }
}

/** Tải trạng thái ban đầu */
function loadSessionState() {
    showScreen('question-screen');
}


// === Event Listeners (Game-specific) ===
document.addEventListener('DOMContentLoaded', async () => {
    if (document.getElementById('question-screen')) {
        // Init game
        await initialize(); 
        await loadSuggestedQuestions(); 
        await loadCardMeanings(); // Tải bảng tra cứu
        loadSessionState(); 

        // Auto-grow textareas
        questionInput.addEventListener('input', () => autoGrow(questionInput));
        followUpInput.addEventListener('input', () => autoGrow(followUpInput));
        
        // (MỚI) Gắn listener cho thanh tìm kiếm
        const cardSearchInput = document.getElementById('card-search-input');
        if (cardSearchInput) {
            // Dùng 'input' để lọc ngay cả khi dán (paste) hoặc xóa
            cardSearchInput.addEventListener('input', filterCardTable);
        }

        // Enter key listeners
        questionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handleQuestionSubmit();
            }
        });
        
        followUpInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handleFollowUpSubmit();
            }
        });

        // Button click listeners
        submitQuestionBtn.addEventListener('click', handleQuestionSubmit);
        
        suggestedQuestionsToggle.addEventListener('click', () => {
            suggestedQuestionsList.classList.toggle('open');
            suggestedQuestionsToggle.classList.toggle('open');
        });

        suggestedQuestionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                questionInput.value = e.target.dataset.question;
                autoGrow(questionInput);
                suggestedQuestionsList.classList.remove('open');
                suggestedQuestionsToggle.classList.remove('open');
            }
        });
        
        readingOptionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                readingOptionBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                numCardsToChoose = parseInt(btn.dataset.value, 10);
                console.log("Số lá bài được chọn: ", numCardsToChoose);
            });
        });

        // Đóng dropdown khi click ra ngoài
        document.addEventListener('click', (e) => {
            if (suggestedQuestionsToggle && !suggestedQuestionsToggle.contains(e.target) && !suggestedQuestionsList.contains(e.target)) {
                suggestedQuestionsList.classList.remove('open');
                suggestedQuestionsToggle.classList.remove('open');
            }
        });

        getInterpretationButton.addEventListener('click', handleGetInterpretation);
        followUpSubmitBtn.addEventListener('click', handleFollowUpSubmit);
    }
});
    </script>
</body>
</html>