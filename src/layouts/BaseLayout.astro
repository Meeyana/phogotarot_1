---
// src/layouts/BaseLayout.astro

// 1. IMPORT FONT (Tối ưu LCP - Thay thế cho Google Fonts Link)
import '@fontsource/playfair-display/700.css'; // Chỉ nạp weight 700
import '@fontsource/quicksand/400.css';
import '@fontsource/quicksand/600.css';
import '@fontsource/quicksand/700.css';

// 2. IMPORT CSS LOCAL
// Lưu ý: Tốt nhất bạn nên di chuyển file 'style.css' từ 'public/' vào 'src/styles/'
// Nếu bạn vẫn để ở public thì giữ nguyên thẻ link bên dưới, nhưng Astro khuyên dùng import thế này để nén code:
import '../styles/global.css'; 

export interface Props {
  title: string;
  description: string;
  ogImage?: string;
  showChatbot?: boolean;
}

import OracleChat from '../components/OracleChat.astro';

const { 
  title, 
  description, 
  ogImage = '/images/phogotarot-og-image.jpg',
  showChatbot = true 
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImageURL = new URL(ogImage, Astro.site);
---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:type" content="website" />

    <link 
      rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" 
      crossorigin="anonymous" 
      referrerpolicy="no-referrer"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    </noscript>
    
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" defer></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CF1CK7N9BR"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CF1CK7N9BR');
    </script>
    
    {Astro.url.pathname === '/' && (
      <script type="application/ld+json" is:inline>
        {
          "@context": "https://schema.org",
          "@graph": [
            {
              "@type": "WebSite",
              "@id": "https://phogotarot.com/#website",
              "url": "https://phogotarot.com/",
              "name": "Phở Gõ Tarot",
              "description": "Nền tảng xem Tarot Online và giải mã thần số học uy tín.",
              "publisher": {
                "@id": "https://phogotarot.com/#organization"
              },
              "inLanguage": "vi-VN"
            },
            {
              "@type": "Organization",
              "@id": "https://phogotarot.com/#organization",
              "name": "Phở Gõ Tarot",
              "alternateName": ["Pho Go Tarot", "Tiệm Phở Gõ Tarot"],
              "url": "https://phogotarot.com/",
              "logo": {
                "@type": "ImageObject",
                "url": "https://phogotarot.com/images/logo.png",
                "width": 112,
                "height": 112
              },
              "description": "Dịch vụ xem Tarot trực tuyến, chữa lành tâm hồn và định hướng tương lai. Không bán phở, chỉ bán lời khuyên.",
              "sameAs": [
                "https://www.facebook.com/phogotarot",
                "https://www.tiktok.com/@phogo_tarot",
                "https://www.instagram.com/pho_go_tarot/",
                "https://www.youtube.com/@phogotarot"
              ]
            }
          ]
        }
        </script>
    )}
    <slot name="head" />

    <style is:global>
      /* Ngăn kéo thả hình ảnh */
      img {
        -webkit-user-drag: none;
        user-drag: none;
        pointer-events: none;
      }
      
      input, textarea {
        -webkit-user-select: auto;
        user-select: auto;
      }

      .clear-history-btn {
            background: transparent;
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: all 0.3s ease;
            display: none;
        }

        .clear-history-btn:hover {
            background: #ff6b6b;
            color: white;
        }
    </style>
</head>

<body>
    <div id="stars-bg"></div>

    <nav class="main-nav">
        <div class="nav-logo">
            <a href="/" class="nav-link logo-link">
                <img src="/images/logo.png" alt="Phở Gõ Tarot" class="nav-logo-image" width="50" height="50">
            </a>
        </div>
        
        <div class="nav-links" id="nav-links">
            <a href="/" class="nav-link">Trang Chủ</a>
            
            <div class="nav-item nav-dropdown">
                <div class="nav-link" id="tarot-dropdown-toggle" style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    <span>Bói Tarot Free</span>
                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="dropdown-submenu">
                    <a href="/tarot" class="nav-link submenu-link">Trải bài 3 lá</a>
                    <a href="/yes-no-reading" class="nav-link submenu-link">Câu hỏi Yes/No</a>
                    <a href="/zodiac-daily" class="nav-link submenu-link">Zodiac Tarot</a>
                </div>
            </div>
            <a href="/than-so-hoc" class="nav-link">Thần số học</a>
            <a href="/about-us" class="nav-link">Về chúng tôi</a>
            <a href="/cards" class="nav-link">Các lá bài Tarot</a>
            <a href="/blog" class="nav-link">Blog</a>
            <a href="/contact" class="nav-link">Liên hệ</a>
            <a href="#" id="history-nav-link" class="nav-link">Lịch sử</a>
        </div>

        <button class="nav-toggle" id="nav-toggle" aria-label="toggle navigation">
            <span class="hamburger"></span>
        </button>
    </nav>
    
    <slot />

    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-column brand">
                <a href="/" class="footer-logo">
                    <img src="/images/logo.png" alt="Phở Gõ Tarot" class="footer-logo-image" loading="lazy" width="100" height="100">
                </a>
                <p class="footer-description">
                    Tarot không phải là công cụ dự đoán tương lai, mà là cung cấp những 
                    gợi ý để bạn tự khám phá và quyết định con đường của mình.
                </p>
                <div class="footer-social-links">
                    <a href="https://www.facebook.com/phogotarot" target="_blank" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
                    <a href="https://www.youtube.com/@phogotarot" target="_blank" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
                    <a href="https://www.instagram.com/pho_go_tarot/" target="_blank" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
                    <a href="https://www.tiktok.com/@phogo_tarot" target="_blank" aria-label="TikTok"><i class="fa-brands fa-tiktok"></i></a>
                </div>
            </div>
            
            <div class="footer-column links">
                <h3 class="footer-title">Chính sách</h3>
                <ul class="footer-link-list">
                    <li><a href="/about-us">Về chúng tôi</a></li>
                    <li><a href="/contact">Liên hệ</a></li>
                    <li><a href="/privacy-policy">Chính sách bảo mật</a></li>
                    <li><a href="/disclaimer">Miễn trừ trách nhiệm</a></li>
                </ul>
            </div>
            
            <div class="footer-column contact">
                <h3 class="footer-title">Thông tin liên hệ</h3>
                <ul class="footer-link-list">
                    <li>
                        <i class="fa-solid fa-location-dot"></i>
                        <span>Quận Bình Thạnh, Hồ Chí Minh, VN</span>
                    </li>
                    <li>
                        <i class="fa-solid fa-phone"></i>
                        <a href="tel:0352677543">0352 677 543</a>
                    </li>
                    <li>
                        <i class="fa-solid fa-envelope"></i>
                        <a href="mailto:contact@phogotarot.com">contact@phogotarot.com</a>
                    </li>
                    <li>
                        <i class="fa-solid fa-globe"></i>
                        <a href="https://phogotarot.com" target="_blank">https://phogotarot.com</a>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="footer-copyright">
            &copy; 2025 Phở Gõ Tarot. Mọi quyền được bảo lưu.
        </div>
    </footer>

    <div id="history-modal-backdrop" class="modal-backdrop"></div>
    <div id="history-modal-content" class="modal-content">
        <div class="modal-header">
            <button id="history-modal-close-btn" class="modal-close-btn">&times;</button>
            <h2>Lịch sử trải bài</h2>
            <button id="clear-tarot-history-btn" class="clear-history-btn" title="Xóa toàn bộ dữ liệu">
                <i class="fa-solid fa-trash-can"></i> Xóa tất cả
            </button>
        </div>
        <div id="history-list-wrapper" class="modal-scroll-wrapper">
            <div id="history-list"></div>
        </div>
    </div>
    
    {showChatbot && <OracleChat />}

    <script src="/common.js" defer></script>
    
    <script is:inline>
        document.addEventListener('DOMContentLoaded', () => {
            const currentPath = window.location.pathname;
            
            // 1. Định nghĩa hàm tô màu Vàng (Active Style)
            const setActiveStyle = (element) => {
                if (!element) return;
                element.style.color = 'var(--gold-color, #F2C94C)';
                element.style.textShadow = '0 0 10px rgba(242, 201, 76, 0.5)';
                element.classList.add('active');
                
                // Nếu là SVG mũi tên bên trong, cũng cho sáng luôn
                const arrow = element.querySelector('.dropdown-arrow');
                if (arrow) arrow.style.fill = 'var(--gold-color, #F2C94C)';
            };

            // 2. Duyệt tất cả các thẻ <a> trong menu
            const navLinks = document.querySelectorAll('a.nav-link');
            navLinks.forEach(link => {
                const href = link.getAttribute('href');

                // Logic so sánh: 
                // - Trùng khớp hoàn toàn (href === currentPath)
                // - Hoặc là trang con (VD: đang ở /blog/bai-viet-1 thì menu /blog vẫn sáng), trừ trang chủ '/'
                if (href && (href === currentPath || (href !== '/' && currentPath.startsWith(href)))) {
                    
                    // A. Tô vàng chính link con đó
                    setActiveStyle(link);

                    // B. KÍCH HOẠT MENU MẸ (Quan trọng)
                    // Kiểm tra xem link này có nằm trong menu xổ xuống không
                    const parentSubmenu = link.closest('.dropdown-submenu');
                    
                    if (parentSubmenu) {
                        // Tìm thẻ cha bao bọc (nav-item)
                        const parentNavItem = parentSubmenu.closest('.nav-item');
                        if (parentNavItem) {
                            // Tìm cái nút tiêu đề (VD: Bói Tarot Free) nằm cùng cấp
                            // Nó là thẻ có class .nav-link nhưng không phải là thẻ a (hoặc có id toggle)
                            const parentToggle = parentNavItem.querySelector('#tarot-dropdown-toggle, .nav-link:not(a)');
                            setActiveStyle(parentToggle);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>