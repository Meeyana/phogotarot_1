---
// 1. IMPORT (Giữ nguyên)
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 2. LẤY DỮ LIỆU TỪ COLLECTION 'blog'
const blogPosts = await getCollection('blog');

// 3. TRỘN VÀ SẮP XẾP (Giữ nguyên)
const allPosts = blogPosts.map(post => ({
  ...post,
  type: 'blog',
  url: `/blog/${post.slug}`
})).sort((a, b) => {
  const dateA = a.data.pubDate ? new Date(a.data.pubDate) : new Date(0);
  const dateB = b.data.pubDate ? new Date(b.data.pubDate) : new Date(0);
  return dateB.getTime() - dateA.getTime();
});

// ==========================================================
// 4. (MỚI) LOGIC PHÂN TRANG NÂNG CAO
// ==========================================================

// Hàm (helper) tạo một mảng số
const range = (start: number, end: number) => {
  let length = end - start + 1;
  return Array.from({ length }, (_, idx) => idx + start);
};

// Hàm (helper) chính để tạo các nút phân trang
const generatePagination = (currentPage: number, totalPages: number) => {
  const totalVisiblePages = 7;
  const DOTS = '...';

  if (totalPages <= totalVisiblePages) {
    return range(1, totalPages);
  }

  const siblings = 1;
  const leftSiblingIndex = Math.max(currentPage - siblings, 1);
  const rightSiblingIndex = Math.min(currentPage + siblings, totalPages);

  const showLeftDots = leftSiblingIndex > 2;
  const showRightDots = rightSiblingIndex < totalPages - 2;

  const firstPageIndex = 1;
  const lastPageIndex = totalPages;

  if (!showLeftDots && showRightDots) {
    let leftItemCount = 3 + 2 * siblings;
    let leftRange = range(1, leftItemCount);
    return [...leftRange, DOTS, totalPages];
  }
  
  if (showLeftDots && !showRightDots) {
    let rightItemCount = 3 + 2 * siblings;
    let rightRange = range(totalPages - rightItemCount + 1, totalPages);
    return [firstPageIndex, DOTS, ...rightRange];
  }
  
  if (showLeftDots && showRightDots) {
    let middleRange = range(leftSiblingIndex, rightSiblingIndex);
    return [firstPageIndex, DOTS, ...middleRange, DOTS, lastPageIndex];
  }

  return range(1, totalPages);
};

// ==========================================================
// 5. (MỚI) ÁP DỤNG LOGIC
// ==========================================================
const pageSize = 12; // 12 bài viết mỗi trang
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const totalPages = Math.ceil(allPosts.length / pageSize);

// Cắt (slice) mảng để chỉ lấy 12 bài cho trang hiện tại
const postsForThisPage = allPosts.slice(
  (currentPage - 1) * pageSize, // Vị trí bắt đầu
  currentPage * pageSize      // Vị trí kết thúc
);

// Tạo ra mảng các nút trang
const paginationItems = generatePagination(currentPage, totalPages);

// 6. (CẬP NHẬT) TẠO JSON-LD AN TOÀN
const siteUrl = Astro.site ? Astro.site.href : '/';
const pageUrl = new URL(`/bai-viet?page=${currentPage}`, siteUrl).href;

const schema = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": `Bài Viết Tarot (Trang ${currentPage}) | Phở Gõ Tarot`,
  "description": "Tổng hợp các bài viết mới nhất về ý nghĩa lá bài, các phương pháp luận giải và kiến thức tarot chuyên sâu từ Phở Gõ Tarot.",
  "url": pageUrl,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": postsForThisPage.map((post, index) => { // DÙNG postsForThisPage
      const postUrl = new URL(post.url, siteUrl).href;
      const postImage = post.data.image
                        ? new URL(post.data.image, siteUrl).href
                        : null;

      return {
        "@type": "ListItem",
        "position": (currentPage - 1) * pageSize + index + 1, // Vị trí chính xác
        "item": {
          "@type": "Article",
          "name": post.data.title,
          "url": postUrl,
          ...(postImage && { "image": postImage })
        }
      };
    })
  }
};
---
<BaseLayout
  title={`Blog - Bài Viết Tarot (Trang ${currentPage}) | Phở Gõ Tarot`}
  description="Tổng hợp các bài viết mới nhất về ý nghĩa lá bài, các phương pháp luận giải và kiến thức tarot chuyên sâu từ Phở Gõ Tarot."
>
  <main id="homepage-content">
    <section class="homepage-section" style="padding-top: 3rem; min-height: 80vh;">
      <div class="container">
        <h2 class="section-title">Bài Viết Tarot</h2>

        <div class="grid-3">

          {/* (SỬA) Dùng postsForThisPage thay vì allPosts */}
          {postsForThisPage.map(post => (
            <div class="blog-card">
              <a href={post.url} class="image-link-wrapper">
                <div class="image-wrapper-4-3">
                   <img src={post.data.image} alt={post.data.title} class="section-image" loading="lazy" />
                </div>
              </a>

              <a href={post.url} class="title-link">
                <h3 class="section-subtitle">{post.data.title}</h3>
              </a>

              <p class="section-text">{post.data.excerpt}</p>
         
              <a href={post.url} class="btn-outline">Đọc tiếp &rarr;</a>
            </div>
          ))}
        </div>

        <nav class="pagination-nav">
          
          <a 
            href={`/blog/bai-viet?page=${currentPage - 1}`} 
            class:list={["page-item", "prev", { "disabled": currentPage === 1 }]}
          >
            &larr;
          </a>

          {paginationItems.map((item) => {
            // Nếu là dấu "..."
            if (item === '...') {
              return <span class="page-item dots disabled">...</span>;
            }
            // Nếu là trang hiện tại (active)
            if (item === currentPage) {
              return <span class="page-item active">{item}</span>;
            }
            // Là các trang khác
            return (
              <a href={`/blog/bai-viet?page=${item}`} class="page-item">
                {item}
              </a>
            );
          })}

          <a 
            href={`/blog/bai-viet?page=${currentPage + 1}`} 
            class:list={["page-item", "next", { "disabled": currentPage === totalPages }]}
          >
            &rarr;
          </a>
        </nav>

      </div>
    </section>
  </main>

  <script
    type="application/ld+json"
    slot="head"
    set:html={JSON.stringify(schema)}
  />

  <style>
      /* ... CSS cũ cho thẻ bài (giữ nguyên) ... */
       .homepage-section { padding: 4rem 1rem; position: relative;}
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 0;
        }
        .section-title { font-family: var(--font-title); color: var(--font-title-color); font-size: 3rem; margin-bottom: 3rem; text-align: center; }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
            gap: 1.5rem;
        }
        .blog-card {
            border: 1px solid var(--card-back-border);
            background-color: var(--button-bg);
            padding: 1rem;
            border-radius: 12px;
            text-align: left;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .image-link-wrapper {
            display: block;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
        }
        .image-wrapper-4-3 {
            width: 100%;
            aspect-ratio: 4 / 3;
            flex-shrink: 0;
        }
        .section-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0;
            margin-bottom: 0;
            transition: transform 0.3s ease;
        }
        .image-link-wrapper:hover .section-image {
            transform: scale(1.05);
        }
        .title-link {
            text-decoration: none!important;
            color: inherit;
        }
        .section-subtitle {
            font-family: var(--font-title);
            color: var(--title-color);
            font-size: 1.25rem;
            margin-bottom: 1rem;
            margin-top: 0;
        }
        .section-text {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
            text-shadow: none;
            flex-grow: 1;
        }
        .btn-outline {
            display: inline-block;
            background: transparent;
            border: 1px solid var(--card-back-border);
            color: var(--title-color);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            text-shadow: none;
            align-self: flex-start;
        }
        .btn-outline:hover { background-color: var(--button-hover-bg); }

    /* --- (MỚI) CSS CHO PHÂN TRANG SỐ --- */
    .pagination-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem; /* Giảm gap để các nút gần nhau hơn */
      margin-top: 3rem;
      flex-wrap: wrap; /* Cho phép xuống dòng nếu quá nhiều nút */
    }

    .page-item {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      border-radius: 8px;
      min-width: 40px; /* Đặt chiều rộng tối thiểu */
      height: 40px; /* Đặt chiều cao cố định */
      padding: 0.25rem 0.75rem;
      text-decoration: none;
      text-shadow: none;
      color: var(--text-color);
      border: 1px solid var(--card-back-border);
      background: var(--button-bg);
      transition: all 0.2s ease;
    }

    /* Nút số, prev/next khi hover */
    .page-item:not(.disabled):not(.active):hover {
      background: var(--button-hover-bg);
      color: var(--title-color);
      border-color: var(--title-color);
    }

    /* Nút trang hiện tại (active) */
    .page-item.active {
      background: var(--title-color);
      color: var(--bg-color);
      border-color: var(--title-color);
    }

    /* Nút bị vô hiệu hóa (..., nút prev/next ở đầu/cuối) */
    .page-item.disabled {
      opacity: 0.5;
      background: transparent;
      pointer-events: none; /* Không cho phép click */
    }
    .page-item.dots {
      border: none;
      background: transparent;
    }
  </style>
</BaseLayout>