---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// --- 1. SECTION: KIẾN THỨC TAROT (CẬP NHẬT LOGIC) ---
const allBlogPosts = await getCollection('blog');
// Tìm bài viết được ghim (nếu có)
let featuredBlogPost = allBlogPosts.find(post => post.data.isFeatured === true);
// Sắp xếp TẤT CẢ bài viết theo ngày mới nhất (để làm dự phòng)
const sortedBlogPosts = allBlogPosts.sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());
// (MỚI) Nếu không có bài nào ghim, tự động lấy bài mới nhất làm bài ghim
// Điều này giúp trang không bao giờ bị lỗi
if (!featuredBlogPost) {
  featuredBlogPost = sortedBlogPosts[0];
}

// (MỚI) Lấy 3 bài viết tiếp theo,
// đảm bảo loại bỏ bài viết đã ghim ra khỏi danh sách này
const otherBlogPosts = sortedBlogPosts
  .filter(post => post.slug !== featuredBlogPost?.slug) // Lọc bỏ bài ghim
  .slice(0, 3);
// Lấy 3 bài tiếp theo

// --- 2. SECTION: Ý NGHĨA LÁ BÀI (Logic giữ nguyên) ---
const featuredCardPosts = (await getCollection('cards'))
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
  .slice(0, 3);
// --- 3. SCHEMA CHO TRANG HUB (CẬP NHẬT) ---

// (MỚI) Gộp tất cả các bài viết hiển thị trên trang để đưa vào schema
const allPostsForSchema = [featuredBlogPost, ...otherBlogPosts, ...featuredCardPosts]
  .filter(Boolean);
// Lọc bỏ 'undefined' nếu featuredBlogPost không tồn tại

// (MỚI) Tạo URL gốc an toàn
const siteUrl = Astro.site ?
Astro.site.href : '/';
const pageUrl = new URL('/blog', siteUrl).href;

const schema = {
  "@context": "https://schema.org",
  "@type": "Blog", // (CẬP NHẬT) Dùng "Blog" hoặc "CollectionPage"
  "name": "Blog - Bài Viết | Phở Gõ Tarot",
  "description": "Tổng hợp các bài viết mới nhất về ý nghĩa lá bài, các phương pháp luận giải và kiến thức tarot chuyên sâu từ Phở Gõ Tarot.",
  "url": pageUrl, // (CẬP NHẬT) Dùng URL an toàn
  
  // (MỚI) Thêm danh sách các bài viết
  "mainEntity": {
    "@type": "ItemList",
    // === LỖI ĐÃ SỬA Ở ĐÂY ===
    "itemListElement": allPostsForSchema.map((post, index) => {
      // (MỚI) Xử lý URL khác nhau cho 'blog' và 'cards'
      const isCard = post.collection === 'cards';
      const postUrlPath = isCard 
        ? `/y-nghia-la-bai/${post.slug}` 
        : `/blog/${post.slug}`;
      
      const postUrl = new URL(postUrlPath, siteUrl).href;

      // (MỚI) Chỉ tạo URL ảnh nếu post.data.image tồn tại
      const postImage = post.data.image 
                        ? new URL(post.data.image, siteUrl).href 
                        : null;
      return {
        "@type": "ListItem",
        "position": index + 1,
        "item": {
          "@type": "Article", // Khai báo mỗi mục là một "Article"
          "name": post.data.title,
          "url": postUrl,
          // (MỚI) Chỉ thêm 'image' vào schema nếu nó không null
          ...(postImage && { "image": postImage })
        }
      };
    })
  }
};
---
<BaseLayout
  title="Blog - Bài Viết | Phở Gõ Tarot"
  description="Tổng hợp các bài viết, kiến thức và ý nghĩa các lá bài Tarot."
>
  <main id="homepage-content">
    
    <section class="homepage-section" style="padding-top: 3rem;">
      <div class="container">
        
        <div class="section-header">
          <h2 class="section-title">Bài Viết Tarot</h2>
        </div>

        {featuredBlogPost && (
          <div class="featured-post-card">
     
           <a href={`/blog/${featuredBlogPost.slug}`} class="featured-image-link">
              <img src={featuredBlogPost.data.image} alt={featuredBlogPost.data.title} class="section-image-featured" />
            </a>
            <div class="featured-content">
              <a href={`/blog/${featuredBlogPost.slug}`} class="title-link">
                <h3 class="section-subtitle">{featuredBlogPost.data.title}</h3>
           
       </a>
 
               <p class="section-text">{featuredBlogPost.data.excerpt}</p>
              <a href={`/blog/${featuredBlogPost.slug}`} class="btn-outline">Đọc tiếp &rarr;</a>
            </div>
          </div>
        )}

        <div class="grid-4">
          {otherBlogPosts.map(post => (
           
  <div class="blog-card">
    
           <a href={`/blog/${post.slug}`} class="image-link-wrapper">
                <div class="image-wrapper-4-3">
                  <img src={post.data.image} alt={post.data.title} class="section-image" />
                </div>
              </a>
            
   <a href={`/blog/${post.slug}`} class="title-link">
   
               <h3 class="section-subtitle">{post.data.title}</h3>
              </a>
              <p class="section-text">{post.data.excerpt}</p>
              <a href={`/blog/${post.slug}`} class="btn-outline">Đọc tiếp &rarr;</a>
            </div>
          ))}
        
 </div>

        <div class="section-footer-action">
          <a href="/blog/bai-viet" class="btn-outline btn-key">Xem thêm &rarr;</a>
        </div>

      </div>
   
   </section>

    <section class="homepage-section" style="padding-top: 1rem;">
      <div class="container">
        
        <div class="section-header">
          <h2 class="section-title">Ý Nghĩa Lá Bài</h2>
        </div>

        <div class="grid-4">
          {featuredCardPosts.map(post => (
          
     <div class="blog-card">
              <span class="category-badge card-badge">Ý nghĩa lá bài</span>

              <a href={`/y-nghia-la-bai/${post.slug}`} class="image-link-wrapper">
                <div class="image-wrapper-4-3">
                  <img src={post.data.image} alt={post.data.title} class="section-image" />
         
               </div>
       
         </a>
              <a href={`/y-nghia-la-bai/${post.slug}`} class="title-link">
                <h3 class="section-subtitle">{post.data.title}</h3>
              </a>
              <p class="section-text">{post.data.excerpt}</p>
              <a 
 href={`/y-nghia-la-bai/${post.slug}`} class="btn-outline">Đọc tiếp &rarr;</a>
            </div>
 
           ))}
        </div>

        <div class="section-footer-action">
          <a href="/blog/y-nghia-la-bai" class="btn-outline btn-key">Xem thêm &rarr;</a>
        </div>

      </div>
    </section>

  </main>
    
  <script 
    type="application/ld+json" 
    slot="head"
    set:html={JSON.stringify(schema)}
  />

  <style>
    /* === CSS CHUNG CHO LAYOUT (Giữ nguyên) === */
    .homepage-section { padding: 4rem 1rem;
 position: relative;}
    .container { 
        max-width: 1200px; 
        margin: auto;
 padding: 0; 
    }
    .section-title { 
        font-family: var(--font-title); 
        color: var(--title-color);
 font-size: 3rem; 
        margin-bottom: 3rem; 
        text-align: center;
        margin-top: 0;
    }
    .btn-outline { 
        display: inline-block;
 background: transparent; 
        border: 1px solid var(--card-back-border); 
        color: var(--title-color); padding: 0.75rem 1.5rem; 
        border-radius: 8px; font-weight: 600; 
        text-decoration: none; text-shadow: none;
 align-self: flex-start; 
    }
    .btn-outline:hover { background-color: var(--button-hover-bg);
 }

    .btn-key{
        /* align-self: center!important; (Không cần thiết nữa) */
 }

    /* === (ĐÃ SỬA) CĂN GIỮA TIÊU ĐỀ === */
    .section-header {
      display: flex;
      justify-content: center; /* <-- SỬA Ở ĐÂY */
      align-items: center;
      margin-bottom: 3rem;
 flex-wrap: wrap; 
      gap: 1rem;
    }
    .section-header .section-title {
      margin-bottom: 0; 
      text-align: center; /* <-- SỬA Ở ĐÂY */
 font-size: 2.5rem; 
    }
    .grid-4 { 
        display: grid;
 grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 1.5rem; 
    }
    @media (min-width: 1024px) {
      .grid-4 {
        grid-template-columns: repeat(3, 1fr);
 }
    }

    /* === (MỚI) CSS CHO NÚT XEM THÊM Ở CUỐI === */
    .section-footer-action {
      text-align: center;
      margin-top: 2.5rem; /* Thêm khoảng cách với lưới bài viết */
    }

    /* === CSS CHO BÀI VIẾT KEY (Giữ nguyên) === */
    .featured-post-card {
      background-color: var(--button-bg);
 border: 1px solid var(--card-back-border);
      border-radius: 12px;
      margin-bottom: 3rem; 
      display: grid;
      grid-template-columns: 1fr; 
      overflow: hidden;
 }
    .featured-image-link {
      display: block;
      width: 100%;
      aspect-ratio: 16 / 9;
 overflow: hidden;
    }
    .section-image-featured {
      width: 100%;
      height: 100%;
      object-fit: cover;
 transition: transform 0.3s ease;
    }
    .featured-image-link:hover .section-image-featured {
      transform: scale(1.05);
 }
    .featured-content {
      padding: 1.5rem;
 }
    .featured-content .section-subtitle { 
        font-family: var(--font-title); 
        color: var(--title-color);
 font-size: 1.75rem; 
        margin-bottom: 1rem;
        margin-top: 0; 
    }
    .featured-content .section-text { 
        font-size: 1.1rem;
 opacity: 0.9; 
        margin-bottom: 1.5rem; 
        text-shadow: none; 
    }
    .featured-content .title-link {
      text-decoration: none!important;
 color: inherit;
    }
    @media (min-width: 900px) {
      .featured-post-card {
        grid-template-columns: 1fr 1.5fr;
 }
      .featured-image-link {
        aspect-ratio: auto;
 }
      .featured-content {
        padding: 2rem;
 }
    }
    @media (max-width: 600px) {
      /* ... CSS responsive cho featured post ... */
    }

    /* === CSS CHO CARD (Giữ nguyên) === */
    .blog-card { 
        border: 1px solid var(--card-back-border);
 background-color: var(--button-bg); 
        padding: 1rem; 
        border-radius: 12px; 
        text-align: left; 
        height: 100%; 
        display: flex;
        flex-direction: column;
        position: relative;
 /* Thêm để định vị badge */
    }
    .image-link-wrapper {
        display: block;
 margin-bottom: 1.5rem;
        border-radius: 12px;
        overflow: hidden;
    }
    .image-wrapper-4-3 {
        width: 100%;
 aspect-ratio: 4 / 3;
        flex-shrink: 0;
    }
    .section-image { 
        width: 100%;
 height: 100%; 
        object-fit: cover; 
        border-radius: 0; 
        margin-bottom: 0;
        transition: transform 0.3s ease;
 }
    .image-link-wrapper:hover .section-image {
        transform: scale(1.05);
 }
    .title-link {
        text-decoration: none!important;
        color: inherit;
 }
    .blog-card .section-subtitle { /* Dùng .blog-card để ưu tiên hơn */
        font-family: var(--font-title);
 color: var(--title-color); 
        font-size: 1.25rem; 
        margin-bottom: 1rem;
        margin-top: 0;
    }
    .blog-card .section-text { /* Dùng .blog-card để ưu tiên hơn */
        font-size: 1rem;
 opacity: 0.9; 
        margin-bottom: 1.5rem; 
        text-shadow: none; 
        flex-grow: 1;
    }

    /* === CSS CHO BADGE (Giữ nguyên) === */
    .category-badge {
      position: absolute;
 top: 1.5rem;
      left: 1.5rem;
      background-color: var(--title-color);
      color: var(--bg-color);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      z-index: 2;
 text-shadow: none;
    }
    .category-badge.card-badge {
      background-color: #a67dff;
 /* Ví dụ màu tím */
    }
    .category-badge.blog-badge {
      background-color: #3f83f8;
 /* Ví dụ màu xanh */
    }
  </style>
</BaseLayout>