---
// 1. Import Layout
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 2. Lấy 'slug' từ URL
const { slug } = Astro.params;

// 3. Lấy TẤT CẢ lá bài
const allCards = await getCollection('cards');

// 4. Tìm lá bài hiện tại
const card = allCards.find(c => c.slug === slug);

// 5. Xử lý 404
if (!card) {
  return Astro.redirect('/404');
}

// 6. Render dữ liệu
const { Content } = await card.render();
const { title, excerpt, image, upright_keywords, reversed_keywords, pubDate, group, index } = card.data;

// 7. Xử lý ngày đăng
const postDate = pubDate ? new Date(pubDate) : null;
const displayDate = postDate ? postDate.toLocaleDateString('vi-VN', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
}) : null;

// 8. Schema JSON-LD
const schema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": excerpt,
  "image": new URL(image, Astro.site).href,
  "author": { "@type": "Organization", "name": "Phở Gõ Tarot" },
  "publisher": { "@type": "Organization", "name": "Phở Gõ Tarot", "logo": { "@type": "ImageObject", "url": "https://phogotarot.com/images/logo.png" }},
  ...(postDate && { "datePublished": postDate.toISOString() })
};

// 9. URL chia sẻ
const currentUrl = Astro.url.href;
const shareImage = new URL(image, Astro.site).href;

// 10. Lấy lá bài liên quan (Cùng group)
const relatedCards = allCards
  .filter(item => item.data.group === group && item.data.index !== index)
  .sort((a, b) => a.data.index - b.data.index);

const groupName = group.charAt(0).toUpperCase() + group.slice(1);
---

<BaseLayout
  title={`${title} - Phở Gõ Tarot`}
  description={excerpt}
  ogImage={image} showChatbot={false}>
  <main id="homepage-content">
    <section class="homepage-section" style="padding-top: 4rem; min-height: 80vh;">
      <div class="container">
        
        <nav class="breadcrumbs">
          <a href="/">Trang chủ</a>
          <span class="divider">&raquo;</span>
          <a href="/cards">Các lá bài</a> 
          <span class="divider">&raquo;</span>
          <span class="current">{title}</span>
        </nav>

        <div class="card-detail-layout">
          
          <!-- SIDEBAR (Hình ảnh + Keywords) -->
          <aside class="card-sidebar">
            <div class="card-image-wrapper">
               <img src={image} alt={title} class="card-main-image" />
            </div>
            
            {upright_keywords && upright_keywords.length > 0 && (
              <div class="keywords-box">
                <h4><i class="fa-solid fa-arrow-up"></i> Từ khoá Xuôi</h4>
                <ul class="keywords-list">
                  {upright_keywords.map(kw => <li>{kw}</li>)}
                </ul>
              </div>
            )}

            {reversed_keywords && reversed_keywords.length > 0 && (
              <div class="keywords-box reversed">
                <h4><i class="fa-solid fa-arrow-down"></i> Từ khoá Ngược</h4>
                <ul class="keywords-list">
                  {reversed_keywords.map(kw => <li>{kw}</li>)}
                </ul>
              </div>
            )}
          </aside>

          <!-- NỘI DUNG CHÍNH -->
          <article class="post-main-content">
            <h1 class="hero-title">{title}</h1>

            {displayDate && (
              <div class="post-meta">
                <span>Cập nhật: </span>
                <time datetime={postDate.toISOString()}>{displayDate}</time>
              </div>
            )}

            <div id="post-content">
              <Content />
            </div>

            <!-- Share Buttons -->
            <div class="share-buttons">
              <span>Chia sẻ:</span>
              <a 
                href={`https://www.facebook.com/sharer/sharer.php?u=${currentUrl}`} 
                class="share-btn facebook" 
                target="_blank" 
                rel="noopener noreferrer"
              >
                <i class="fa-brands fa-facebook-f"></i>
              </a>
              <a 
                href={`https://pinterest.com/pin/create/button/?url=${currentUrl}&media=${shareImage}&description=${title}`}
                class="share-btn pinterest" 
                target="_blank" 
                rel="noopener noreferrer"
              >
                <i class="fa-brands fa-pinterest"></i>
              </a>
            </div>

            <div class="post-disclaimer">
              <p><strong>Lưu ý:</strong> Những thông điệp từ Phở Gõ Tarot gửi đến bạn mang ý nghĩa tham khảo và chiêm nghiệm cá nhân. Chúng tôi không thay thế vai trò của các chuyên gia y tế, tài chính hay pháp lý. Mong bạn đón nhận các lá bài với tâm thế cởi mở, lắng nghe trực giác và tự làm chủ quyết định của chính mình.</p>
            </div>
          

            <!-- CTA Banner (Style Gold Mới) -->
            <div class="cta-banner">
              <div class="cta-content">
                <h3>Bạn đang băn khoăn về lá bài này?</h3>
                <p>Đôi khi ý nghĩa lá bài thay đổi tuỳ theo hoàn cảnh. Hãy để Reader của Phở Gõ giúp bạn giải mã thông điệp riêng.</p>
              </div>
              <a href="/tarot" class="cta-button">Trải Bài Ngay</a>
            </div>

            <!-- Related Cards -->
            {relatedCards.length > 0 && (
              <div class="related-cards-section">
                <h3 class="widget-title">Các Lá Bài Cùng Nhóm {groupName}</h3>
                <div class="related-cards-grid">
                  {relatedCards.map(related => (
                    <a href={`/cards/${related.slug}`} class="related-card-item">
                      <div class="related-img-wrapper">
                          <img 
                            src={related.data.image} 
                            alt={related.data.title} 
                            loading="lazy" 
                          />
                      </div>
                      <span>{related.data.title.replace("Ý nghĩa lá bài ", "")}</span>
                    </a>
                  ))}
                </div>
              </div>
            )}
            
            <a href="/cards" class="btn-outline back-btn" style="margin-top: 3rem;">&larr; Quay lại danh sách</a>
          </article>

        </div> 
      </div>
    </section>
  </main>
    
  <script 
    type="application/ld+json" 
    slot="head"
    set:html={JSON.stringify(schema)}
  />

  <style>
    /* --- Cài đặt chung --- */
    .homepage-section { padding: 4rem 1rem; position: relative; z-index: 1; }
    .container { max-width: 1200px; margin: auto; padding: 0 1rem; }

    /* --- LAYOUT 2 CỘT --- */
    .card-detail-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 3rem;
    }
    @media (min-width: 900px) {
      .card-detail-layout {
        grid-template-columns: 350px 1fr; /* Sidebar cố định 350px */
        align-items: start;
      }
    }

    /* --- SIDEBAR STYLE (GOLD THEME) --- */
    .card-sidebar { width: 100%; }
    
    .card-image-wrapper {
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(242, 201, 76, 0.3); /* Viền vàng nhẹ */
        box-shadow: 0 0 20px rgba(242, 201, 76, 0.1); /* Glow nhẹ */
        margin-bottom: 2rem;
        transition: transform 0.3s;
    }
    .card-image-wrapper:hover {
        transform: scale(1.02);
        box-shadow: 0 0 30px rgba(242, 201, 76, 0.2);
    }
    .card-main-image {
      width: 100%; height: auto; display: block;
    }

    /* Hộp từ khóa (Glassmorphism) */
    .keywords-box {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(5px);
    }
    /* Box keywords ngược có màu viền khác chút */
    .keywords-box.reversed {
        border-color: rgba(255, 255, 255, 0.05);
    }

    .keywords-box h4 {
      font-family: var(--font-title);
      color: var(--gold-color, #F2C94C); /* Tiêu đề vàng */
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px dashed rgba(242, 201, 76, 0.3);
      padding-bottom: 0.75rem;
      display: flex; align-items: center; gap: 0.5rem;
    }

    .keywords-list {
      list-style: none; padding: 0; margin: 0;
      display: flex; flex-wrap: wrap; gap: 0.6rem;
    }
    .keywords-list li {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.3rem 0.8rem;
      border-radius: 50px;
      font-size: 0.9rem;
      color: #ddd;
      transition: all 0.2s;
    }
    .keywords-list li:hover {
        border-color: var(--gold-color, #F2C94C);
        color: #fff;
        background: rgba(242, 201, 76, 0.1);
    }

    /* --- MAIN CONTENT --- */
    .post-main-content { width: 100%; }

    .hero-title { 
      font-family: var(--font-title); 
      color: #ffffff; /* Chữ Trắng */
      font-size: 3rem; 
      font-weight: 700;
      margin-bottom: 0.5rem; margin-top: 0;
      text-align: left; 
      line-height: 1.2;
      /* Hiệu ứng Glow Vàng CHỈ CHO TITLE CHÍNH */
      text-shadow: 0 0 10px rgba(242, 201, 76, 0.5), 0 0 30px rgba(242, 201, 76, 0.2);
    }

    .breadcrumbs { margin-bottom: 2rem; font-size: 0.9rem; color: #ccc; }
    .breadcrumbs a { color: #ccc; text-decoration: none; transition: color 0.3s; }
    .breadcrumbs a:hover { color: var(--gold-color, #F2C94C); }
    .breadcrumbs .divider { margin: 0 0.5rem; color: rgba(255,255,255,0.3); }
    .breadcrumbs .current { font-weight: 600; color: var(--gold-color, #F2C94C); }

    .post-meta { font-size: 0.95rem; color: #aaa; margin-bottom: 2rem; }
    .post-meta time { font-weight: 600; color: var(--gold-color, #F2C94C); }

    /* === NỘI DUNG BÀI VIẾT (ĐÃ ĐIỀU CHỈNH LẠI) === */
    #post-content { font-size: 1.1rem; line-height: 1.8; color: #e0e0e0; text-align: left; }
    
    /* H2 (Heading lớn): Giữ vàng nhưng bỏ shadow chói */
    #post-content h2 { 
        font-family: var(--font-title); 
        color: var(--gold-color, #F2C94C); 
        margin-top: 2.5rem; margin-bottom: 1rem;
        font-size: 2rem;
        border-bottom: 1px solid rgba(242, 201, 76, 0.2); 
        padding-bottom: 0.5rem;
        text-shadow: none; /* Bỏ glow */
    }
    
    /* H3, H4...: Chuyển về màu TRẮNG BÌNH THƯỜNG */
    #post-content h3, #post-content h4 {
        font-family: var(--font-title);
        color: #ffffff; 
        margin-top: 2rem; margin-bottom: 0.5rem;
        font-size: 1.5rem;
        text-shadow: none;
    }
    
    #post-content p { margin-bottom: 1.5rem; }
    #post-content ul { padding-left: 1.5rem; margin-bottom: 1.5rem; }
    #post-content :global(strong) { color: #fff; }
    
    /* Link trong bài: Chuyển về màu trắng gạch chân bình thường */
    #post-content :global(a) { 
        color: #fff; 
        text-decoration: underline; 
        font-weight: 600; 
        border-bottom: none; 
        transition: all 0.3s; 
    }
    #post-content :global(a:hover) { 
        color: var(--gold-color, #F2C94C); 
        text-decoration: none;
    }

    /* --- SHARE BUTTONS --- */
    .share-buttons { 
        display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; 
        margin: 3rem 0; padding: 1.5rem 0; 
        border-top: 1px solid rgba(255, 255, 255, 0.1); 
        border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
    }
    .share-buttons span { 
        font-weight: 600; font-family: var(--font-title); font-size: 1.1rem; color: #fff; margin-right: 0.5rem; 
    }
    .share-btn { 
        display: flex; align-items: center; justify-content: center; 
        width: 45px; height: 45px; border-radius: 50%; 
        text-decoration: none; color: #fff; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.1); 
    }
    .share-btn:hover { transform: translateY(-3px); }
    .share-btn.facebook { background-color: #1877F2; box-shadow: 0 0 10px rgba(24, 119, 242, 0.4); }
    .share-btn.pinterest { background-color: #E60023; box-shadow: 0 0 10px rgba(230, 0, 35, 0.4); }

    /* --- CTA BANNER (Style Mới) --- */
    .cta-banner {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(242, 201, 76, 0.3);
      border-radius: 16px;
      padding: 2rem;
      display: flex; flex-direction: column; justify-content: space-between; align-items: center;
      gap: 1.5rem; margin-bottom: 3rem; text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.2);
    }
    .cta-content h3 {
      font-family: var(--font-title); color: var(--gold-color, #F2C94C);
      font-size: 1.75rem; margin: 0 0 0.75rem 0;
      text-shadow: 0 0 15px rgba(242, 201, 76, 0.3);
    }
    .cta-content p { margin: 0; font-size: 1rem; opacity: 0.9; color: #ddd; max-width: 500px; }
    
    .cta-button {
      background: linear-gradient(135deg, #D4AF37 0%, #F2C94C 50%, #FFD700 100%);
      color: #050A1F; text-decoration: none; font-weight: 700;
      padding: 0.9rem 2.2rem; border-radius: 50px; flex-shrink: 0;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); transition: all 0.3s;
    }
    .cta-button:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 0 25px rgba(242, 201, 76, 0.8);
        background: linear-gradient(135deg, #FFF 0%, #FFD700 50%, #F2C94C 100%);
    }
    @media (min-width: 768px) {
      .cta-banner { flex-direction: row; text-align: left; }
      .cta-content { flex-grow: 1; }
    }

    /* --- RELATED CARDS --- */
    .related-cards-section {
      margin-top: 3rem; margin-bottom: 2rem;
    }
    .widget-title {
      font-family: var(--font-title); color: #fff; font-size: 1.75rem;
      margin: 0 0 1.5rem 0; text-shadow: 0 0 15px rgba(242, 201, 76, 0.4);
    }
    .related-cards-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;
    }
    .related-card-item {
      display: block; text-decoration: none;
      border: 1px solid rgba(255, 255, 255, 0.1); /* Viền mảnh */
      border-radius: 12px; overflow: hidden;
      background: rgba(255, 255, 255, 0.02);
      transition: all 0.3s ease;
    }
    .related-card-item:hover {
      transform: translateY(-5px);
      border-color: var(--gold-color, #F2C94C);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3), 0 0 10px rgba(242, 201, 76, 0.1);
    }
    .related-img-wrapper {
        width: 100%; aspect-ratio: 1 / 1.6; overflow: hidden;
    }
    .related-card-item img {
      width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s;
    }
    .related-card-item:hover img { transform: scale(1.1); }
    
    .related-card-item span {
      display: block; padding: 0.75rem; text-align: center;
      font-size: 0.9rem; font-weight: 600; color: #fff;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .related-card-item:hover span { color: var(--gold-color, #F2C94C); }

    @media (min-width: 600px) { .related-cards-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 900px) { .related-cards-grid { grid-template-columns: repeat(4, 1fr); } }

    /* --- Buttons & Back Button --- */
    .btn-outline { 
      display: inline-block; background: transparent; 
      border: 1px solid var(--gold-color, #F2C94C);
      color: var(--gold-color, #F2C94C); padding: 0.7rem 1.5rem; 
      border-radius: 8px; font-weight: 600; text-decoration: none;
      transition: all 0.3s ease;
    }
    .btn-outline:hover { 
        background-color: rgba(242, 201, 76, 0.1);
        box-shadow: 0 0 15px rgba(242, 201, 76, 0.3);
        color: #fff; transform: translateY(-2px);
    }
    .back-btn:hover {
        background-color: var(--gold-color, #F2C94C);
        color: #050A1F; 
        box-shadow: 0 0 20px rgba(242, 201, 76, 0.5);
        transform: translateX(-5px);
    }

    /* Responsive Mobile */
    @media (max-width: 900px) {
      .hero-title { font-size: 2.5rem; }
    }
    @media (max-width: 600px) {
      .homepage-section { padding: 4rem 0.5rem; }
      .container { padding: 0 0.5rem; }
      .hero-title { font-size: 2rem; }
    }

    /* --- Style cho phần Disclaimer (Lưu ý) --- */
    .post-disclaimer {
        margin-bottom: 3rem; /* Cách banner CTA một chút */
        padding: 1.2rem;
        background: rgba(255, 255, 255, 0.03); /* Nền tối mờ nhẹ */
        border-left: 3px solid var(--gold-color, #F2C94C); /* Viền vàng bên trái tạo điểm nhấn */
        border-radius: 0 8px 8px 0;
        font-size: 0.9rem; /* Chữ nhỏ hơn body một chút */
        line-height: 1.6;
        color: #aaa; /* Màu chữ xám nhẹ để không quá nổi bật nhưng vẫn dễ đọc */
        font-style: italic; /* Chữ nghiêng tạo cảm giác lưu ý nhẹ nhàng */
    }
    
    .post-disclaimer strong {
        color: var(--gold-color, #F2C94C);
        font-style: normal;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 1px;
        margin-right: 5px;
    }
  </style>
</BaseLayout>