---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Test API Environment">
  <div style="padding: 50px; text-align: center; max-width: 600px; margin: 0 auto;">
    <h1>üîç Ki·ªÉm tra API (SSR)</h1>
    
    <p>Tr·∫°ng th√°i: <span id="statusText">S·∫µn s√†ng</span></p>

    <button id="btnTest" style="background: #F2C94C; color: #000; padding: 15px 30px; font-weight: bold; border: none; cursor: pointer; border-radius: 8px; margin-top: 20px;">
      G·ªåI API NGAY
    </button>
    
    <div id="result" style="margin-top: 30px; padding: 20px; background: #1a1a1a; color: #0f0; text-align: left; border-radius: 8px; font-family: monospace; min-height: 100px; white-space: pre-wrap;">
      K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...
    </div>
  </div>
</BaseLayout>

<script is:inline>
  // Ch·ªù website t·∫£i xong ho√†n to√†n m·ªõi ch·∫°y code
  document.addEventListener('DOMContentLoaded', () => {
    console.log("--> Script Frontend ƒë√£ ch·∫°y!");

    const btn = document.getElementById('btnTest');
    const resultDiv = document.getElementById('result');
    const statusText = document.getElementById('statusText');

    if (!btn) {
        console.error("L·ªñI: Kh√¥ng t√¨m th·∫•y n√∫t b·∫•m c√≥ ID 'btnTest'");
        return;
    }

    btn.addEventListener('click', async () => {
      console.log("--> ƒê√£ b·∫•m n√∫t! ƒêang g·ªçi API...");
      resultDiv.innerText = "‚è≥ ƒêang k·∫øt n·ªëi server...";
      statusText.innerText = "ƒêang x·ª≠ l√Ω...";
      
      try {
        // G·ªçi API
        const response = await fetch('/api/test-env');
        console.log("--> Server ph·∫£n h·ªìi status:", response.status);

        // ƒê·ªçc text tr∆∞·ªõc ƒë·ªÉ tr√°nh l·ªói JSON parse n·∫øu server tr·∫£ v·ªÅ HTML l·ªói
        const rawText = await response.text();
        console.log("--> D·ªØ li·ªáu th√¥:", rawText);

        let data;
        try {
            data = JSON.parse(rawText);
        } catch (e) {
            throw new Error("Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng ph·∫£i JSON: " + rawText.substring(0, 100));
        }

        if (response.ok) {
           resultDiv.innerHTML = "‚úÖ K·∫æT QU·∫¢ TH√ÄNH C√îNG:\n\n" + JSON.stringify(data, null, 2);
           statusText.innerText = "Th√†nh c√¥ng";
        } else {
           resultDiv.innerHTML = "‚ùå L·ªñI T·ª™ API:\n\n" + JSON.stringify(data, null, 2);
           statusText.innerText = "Th·∫•t b·∫°i";
        }

      } catch (e) {
        console.error("L·ªói fetch:", e);
        resultDiv.innerText = "üî• L·ªñI JAVASCRIPT:\n" + e.message;
        statusText.innerText = "L·ªói nghi√™m tr·ªçng";
      }
    });
  });
</script>