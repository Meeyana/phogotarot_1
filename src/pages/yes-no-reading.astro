---
// 1. IMPORT
import BaseLayout from '../layouts/BaseLayout.astro';

// 2. T·∫†O METADATA V√Ä SCHEMA
const pageTitle = "Tr·∫£i B√†i Tarot Yes/No - C√¢u Tr·∫£ L·ªùi Nhanh | Ph·ªü G√µ Tarot";
const pageDesc = "Nh·∫≠n c√¢u tr·∫£ l·ªùi Yes (C√≥) ho·∫∑c No (Kh√¥ng) nhanh ch√≥ng cho c√°c c√¢u h·ªèi c·ªßa b·∫°n, c√πng v·ªõi lu·∫≠n gi·∫£i AI chi ti·∫øt t·ª´ m·ªôt l√° b√†i Tarot.";
const pageUrl = new URL('/yes-no-reading', Astro.site).href;

// C·∫¨P NH·∫¨T SCHEMA CHU·∫®N GEO/SEO (D·∫°ng Graph cho Yes/No)
const schema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebApplication",
      "name": "B√≥i B√†i Tarot Yes/No Online Mi·ªÖn Ph√≠",
      "url": pageUrl,
      "description": "C√¥ng c·ª• b√≥i b√†i Tarot Yes/No gi√∫p b·∫°n ƒë∆∞a ra quy·∫øt ƒë·ªãnh nhanh ch√≥ng. Ch·ªçn 1 l√° ƒë·ªÉ xem k·∫øt qu·∫£ C√≥/Kh√¥ng t·ª©c th√¨ ho·∫∑c 3 l√° ƒë·ªÉ xem chi ti·∫øt.",
      "applicationCategory": "LifestyleApplication",
      "operatingSystem": "Any"
    },
    {
      "@type": "HowTo",
      "name": "C√°ch ƒê·∫∑t C√¢u H·ªèi Tarot Yes/No Ch√≠nh X√°c Nh·∫•t",
      "description": "H∆∞·ªõng d·∫´n ƒë·∫∑t c√¢u h·ªèi ƒë√≥ng (Closed Questions) ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c c√¢u tr·∫£ l·ªùi d·ª©t kho√°t t·ª´ c√°c l√° b√†i Tarot.",
      "step": [
        {
          "@type": "HowToStep",
          "name": "Ch·ªâ h·ªèi m·ªôt v·∫•n ƒë·ªÅ duy nh·∫•t",
          "text": "Tr√°nh c√¢u h·ªèi 'ho·∫∑c' (V√≠ d·ª•: 'T√¥i n√™n ƒëi du h·ªçc hay ·ªü l·∫°i l√†m vi·ªác?'). H√£y t√°ch th√†nh 2 c√¢u h·ªèi ri√™ng bi·ªát."
        },
        {
          "@type": "HowToStep",
          "name": "Gi·ªõi h·∫°n th·ªùi gian",
          "text": "Th√™m m·ªëc th·ªùi gian c·ª• th·ªÉ nh∆∞ 'trong tu·∫ßn n√†y', 'trong th√°ng t·ªõi' ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c."
        },
        {
          "@type": "HowToStep",
          "name": "S·∫µn s√†ng ƒë√≥n nh·∫≠n s·ª± th·∫≠t",
          "text": "Gi·ªØ t√¢m th√°i trung l·∫≠p, kh√¥ng c·ªë √©p c√°c l√° b√†i ph·∫£i tr·∫£ l·ªùi theo √Ω mu·ªën c·ªßa b·∫°n."
        }
      ]
    },
    {
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "C√≥ n√™n b√≥i Yes/No nhi·ªÅu l·∫ßn cho m·ªôt c√¢u h·ªèi?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Kh√¥ng n√™n. Vi·ªác h·ªèi ƒëi h·ªèi l·∫°i c√πng m·ªôt v·∫•n ƒë·ªÅ trong th·ªùi gian ng·∫Øn s·∫Ω khi·∫øn nƒÉng l∆∞·ª£ng b·ªã nhi·ªÖu lo·∫°n v√† k·∫øt qu·∫£ kh√¥ng c√≤n ch√≠nh x√°c."
          }
        }
      ]
    }
  ]
};
---

<BaseLayout
  title={pageTitle}
  description={pageDesc}
>
    <!-- M√ÄN H√åNH 1: ƒê·∫∂T C√ÇU H·ªéI -->
    <div id="question-screen" class="screen active">
        <h1 class="title">H√£y suy nghƒ© v√† t·∫≠p trung v√†o c√¢u h·ªèi c·ªßa b·∫°n</h1>
        <p class="subtitle">B·∫°n c√≥ th·ªÉ ch·ªçn r√∫t 1 l√° ƒë·ªÉ xem nhanh ho·∫∑c 3 l√° ƒë·ªÉ xem chi ti·∫øt.</p>
        
        <div id="question-input-area" class="question-input-area">
            <textarea id="question-input" class="question-input" placeholder="Vi·∫øt c√¢u h·ªèi Yes/No c·ªßa b·∫°n ·ªü ƒë√¢y..." style="min-height: 56px;"></textarea>
            <button id="submit-question-btn" title="G·ª≠i c√¢u h·ªèi">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
        
        <div id="reading-options-container">
            <button class="reading-option-btn active" data-value="1">
                Ch·ªçn 1 l√°
            </button>
            <button class="reading-option-btn" data-value="3">
                Ch·ªçn 3 l√°
            </button>
        </div>

        <div class="dropdown-container">
            <button id="suggested-questions-toggle" class="dropdown-toggle">
                <span><i class="fa-regular fa-lightbulb"></i> G·ª£i √Ω c√¢u h·ªèi</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16" class="arrow-icon">
                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="suggested-questions-list" class="dropdown-menu">
                <p style="padding: 1rem; opacity: 0.7; text-align: center;">ƒêang t·∫£i g·ª£i √Ω...</p>
            </div>
        </div>
        
        <p id="question-error-display" class="error-message"></p>

        <!-- --- PH·∫¶N M·ªöI: B√ÄI VI·∫æT SEO / GEO (YES/NO SPECIFIC) --- -->
        <div class="seo-divider"></div>
        
        <article class="seo-guide-container">
            <h2 class="seo-title">B√≠ Quy·∫øt ƒê·∫∑t C√¢u H·ªèi Yes/No Tarot Chu·∫©n X√°c</h2>
            <p class="seo-intro">
                Tr·∫£i b√†i Tarot Yes/No l√† c√¥ng c·ª• tuy·ªát v·ªùi cho nh·ªØng quy·∫øt ƒë·ªãnh nhanh. Tuy nhi√™n, ƒë·ªÉ "V≈© tr·ª•" g·ª≠i t√≠n hi·ªáu d·ª©t kho√°t (C√≥ ho·∫∑c Kh√¥ng), b·∫°n c·∫ßn tu√¢n th·ªß nguy√™n t·∫Øc ƒë·∫∑t c√¢u h·ªèi ƒë√≥ng.
            </p>

            <div class="seo-tips-grid">
                <div class="seo-tip-card">
                    <h3 class="tip-title">‚ö° M·ªôt V·∫•n ƒê·ªÅ Duy Nh·∫•t</h3>
                    <p class="tip-content">Tuy·ªát ƒë·ªëi kh√¥ng d√πng t·ª´ <strong>"ho·∫∑c"</strong>. V√≠ d·ª• sai: <em>"T√¥i n√™n ch·ªçn c√¥ng ty A hay c√¥ng ty B?"</em>. H√£y t√°ch th√†nh: <em>"C√¥ng ty A c√≥ t·ªët cho t√¥i kh√¥ng?"</em>.</p>
                </div>
                
                <div class="seo-tip-card">
                    <h3 class="tip-title">üéØ C·ª• Th·ªÉ & Tr·ª±c Ti·∫øp</h3>
                    <p class="tip-content">H√£y ƒëi th·∫≥ng v√†o v·∫•n ƒë·ªÅ. Thay v√¨ <em>"Chuy·ªán t√¨nh c·∫£m th·∫ø n√†o?"</em>, h√£y h·ªèi <em>"Ng∆∞·ªùi ·∫•y c√≥ t√¨nh c·∫£m v·ªõi t√¥i kh√¥ng?"</em>.</p>
                </div>

                <div class="seo-tip-card">
                    <h3 class="tip-title">üö´ Kh√¥ng H·ªèi L·∫°i Ngay</h3>
                    <p class="tip-content">N·∫øu nh·∫≠n ƒë∆∞·ª£c c√¢u tr·∫£ l·ªùi kh√¥ng nh∆∞ √Ω (v√≠ d·ª•: No), ƒë·ª´ng r√∫t b√†i l·∫°i ngay l·∫≠p t·ª©c. H√£y ch·ªù √≠t nh·∫•t 1-2 ng√†y ƒë·ªÉ nƒÉng l∆∞·ª£ng ·ªïn ƒë·ªãnh.</p>
                </div>
            </div>

            <div class="seo-examples">
                <h3 class="example-title">üí° V√≠ D·ª• C√¢u H·ªèi Yes/No ƒêi·ªÉn H√¨nh:</h3>
                <ul class="example-list">
                    <li><strong>T√¨nh y√™u:</strong> "Ng∆∞·ªùi y√™u c≈© c√≥ quay l·∫°i v·ªõi t√¥i trong th√°ng n√†y kh√¥ng?"</li>
                    <li><strong>C√¥ng vi·ªác:</strong> "D·ª± √°n s·∫Øp t·ªõi c√≥ mang l·∫°i l·ª£i nhu·∫≠n t·ªët kh√¥ng?"</li>
                    <li><strong>ƒê·ªùi s·ªëng:</strong> "Chuy·∫øn ƒëi du l·ªãch tu·∫ßn sau c√≥ su√¥n s·∫ª kh√¥ng?"</li>
                </ul>
            </div>
        </article>
        <!-- --- H·∫æT PH·∫¶N B√ÄI VI·∫æT SEO --- -->

        <div id="card-lookup-container-start" class="card-lookup-container">
            <h2>Tra c·ª©u nhanh √Ω nghƒ©a l√° b√†i Yes/No</h2>
            
            <div id="card-search-wrapper">
                <i class="fa-solid fa-search card-search-icon"></i>
                <input type="text" class="card-search-input" data-target="card-lookup-table-1" placeholder="T√¨m ki·∫øm b√†i Tarot...">
            </div>
            
            <div id="card-lookup-table-1">
                <p style="padding: 1rem; opacity: 0.7; text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu tra c·ª©u...</p>
            </div>
        </div>
    </div>

    <!-- M√ÄN H√åNH 2: X√ÅO B√ÄI -->
    <div id="shuffling-screen" class="screen">
        <div id="shuffling-question-display" class="question-display-header"></div>
        <div class="shuffling-animation-container">
            <div class="shuffle-card"></div>
            <div class="shuffle-card"></div>
            <div class="shuffle-card"></div>
        </div>
        <p class="shuffling-instruction">
            H√£y gi·ªØ t·∫≠p trung v√†o c√¢u h·ªèi c·ªßa b·∫°n.
            <br>
            ƒê·ªÉ c√≥ k·∫øt qu·∫£ t·ªët nh·∫•t, b·∫°n kh√¥ng n√™n l√†m vi·ªác ri√™ng trong l√∫c n√†y.
        </p>
    </div>

    <!-- M√ÄN H√åNH 3: CH·ªåN B√ÄI & K·∫æT QU·∫¢ -->
    <div id="drawing-screen" class="screen">
        <div id="drawing-question-display" class="question-display-header"></div>
        
        <h2 class="drawing-subheader">H√£y ch·ªçn 3 l√° b√†i</h2>
        
        <div id="chosen-cards-display">
            <div class="chosen-card-placeholder"></div>
            <div class="chosen-card-placeholder"></div>
            <div class="chosen-card-placeholder"></div>
        </div>
        
        <div id="card-spread-container">
            <div class="card-row" id="card-row-1"></div>
            <div class="card-row" id="card-row-2"></div>
            <div class="card-row mobile-row" id="card-row-3"></div>
            <div class="card-row mobile-row" id="card-row-4"></div>
            <div class="card-row mobile-row" id="card-row-5"></div>
            <div class="card-row mobile-row" id="card-row-6"></div>
        </div>
        
        <div id="action-button-container">
            <button id="get-interpretation-button" class="action-button btn-gold-glow">Xem √Ω nghƒ©a</button>
        </div>
        
        <div is:inline id="interpretation-results-display"></div>
        
        <div id="follow-up-question-container">
            <h3>B·∫°n c√≥ c√¢u h·ªèi n√†o kh√°c kh√¥ng?</h3>
            <div id="follow-up-input-area" class="question-input-area">
                <textarea id="follow-up-question-input" class="question-input" placeholder="ƒê·∫∑t c√¢u h·ªèi ti·∫øp theo..." style="min-height: 56px;"></textarea>
                <button id="submit-follow-up-btn" title="G·ª≠i c√¢u h·ªèi m·ªõi">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>
                </button>
            </div>
            <p id="follow-up-error-display" class="error-message"></p>
        </div>
        
        <div id="card-lookup-container-results" class="card-lookup-container">
            <h2>Tra c·ª©u nhanh √Ω nghƒ©a l√° b√†i</h2>
            
            <div id="card-search-wrapper">
                <i class="fa-solid fa-search card-search-icon"></i>
                <input type="text" class="card-search-input" data-target="card-lookup-table-2" placeholder="T√¨m ki·∫øm b√†i Tarot...">
            </div>
            
            <div id="card-lookup-table-2">
                <p style="padding: 1rem; opacity: 0.7; text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu tra c·ª©u...</p>
            </div>
        </div>
    </div>

    <script 
      type="application/ld+json" 
      slot="head"
      set:html={JSON.stringify(schema)}
    />

    <link rel="preload" href="/card-back.jpg" as="image">

    <style is:inline>
        /* ========================================================== */
        /* === 1. STYLE CHUNG T·ª™ TAROT.ASTRO (THEME DARK BLUE/GOLD) === */
        /* ========================================================== */

        /* === C·∫§U TR√öC CHUNG === */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            min-height: 80vh;
            padding: 2rem 1rem;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        .screen.active { display: flex; animation: fadeIn 0.5s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === TYPOGRAPHY === */
        .title {
            font-family: var(--font-title);
            color: #ffffff;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 15px rgba(242, 201, 76, 0.6), 0 0 30px rgba(242, 201, 76, 0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #ccc; margin-bottom: 2.5rem; text-align: center; text-shadow: none;
        }
        
        .question-display-header {
            font-family: var(--font-title);
            color: var(--gold-color, #F2C94C);
            font-size: 1.5rem; margin-bottom: 1rem; text-align: center;
            text-shadow: 0 0 10px rgba(242, 201, 76, 0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem; width: 100%; max-width: 800px;
        }

        /* === INPUT AREA (GLASSMORPHISM) === */
        #question-screen { padding-top: 6rem; justify-content: flex-start; }
        
        .question-input-area {
            width: 100%;
            max-width: 700px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(242, 201, 76, 0.3);
            border-radius: 16px;
            padding: 0.8rem 1rem;
            display: flex; align-items: center; gap: 0.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: all 0.3s ease;
        }
        .question-input-area:focus-within {
            border-color: var(--gold-color, #F2C94C);
            box-shadow: 0 0 20px rgba(242, 201, 76, 0.15);
            background: rgba(255, 255, 255, 0.08);
        }

        .question-input {
            width: 100%;
            background: transparent; border: none; color: #fff;
            font-family: var(--font-body); font-size: 1.1rem; resize: none;
            text-shadow: none; padding: 0.5rem; flex-grow: 1;
        }
        .question-input:focus { outline: none; }
        .question-input::placeholder { color: rgba(255,255,255,0.3); font-size: 1rem; }

        /* N√∫t G·ª≠i */
        #submit-question-btn, #submit-follow-up-btn {
            flex-shrink: 0;
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background: linear-gradient(135deg, #D4AF37 0%, #F2C94C 50%, #FFD700 100%);
            color: #050A1F; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s; box-shadow: 0 0 10px rgba(242, 201, 76, 0.3);
        }
        #submit-question-btn:hover, #submit-follow-up-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(242, 201, 76, 0.6);
            background: linear-gradient(135deg, #FFF 0%, #FFD700 50%, #F2C94C 100%);
        }
        #submit-question-btn:disabled, #submit-follow-up-btn:disabled {
            opacity: 0.6; cursor: not-allowed; filter: grayscale(1);
        }

        .error-message { color: #ff6b6b; font-weight: 600; margin-top: 1rem; min-height: 1.5em; text-shadow: none; }

        /* === DROPDOWN G·ª¢I √ù (SOLID STYLE) === */
        .dropdown-container { width: 100%; max-width: 700px; margin: 1.5rem 0; position: relative; }
        
        .dropdown-toggle {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15); 
            color: #ddd;
            padding: 0.8rem 1.2rem; border-radius: 12px;
            cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-family: var(--font-body); font-size: 1rem; transition: all 0.3s;
        }
        .dropdown-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }
        .arrow-icon { transition: transform 0.3s; }
        .dropdown-toggle.open .arrow-icon { transform: rotate(180deg); }
        
        .dropdown-menu {
            display: none;
            position: absolute; top: 110%; left: 0; right: 0;
            background-color: #0b132b;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto; z-index: 100;
            padding: 0.5rem 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .dropdown-menu.open { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from{opacity:0; transform:translateY(-5px)} to{opacity:1; transform:translateY(0)} }

        .dropdown-menu::-webkit-scrollbar { width: 5px; }
        .dropdown-menu::-webkit-scrollbar-track { background: transparent; }
        .dropdown-menu::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .dropdown-menu::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        .category-title {
            color: var(--gold-color, #F2C94C);
            font-family: var(--font-title);
            font-size: 0.95rem; font-weight: 700;
            padding: 0.8rem 1rem 0.4rem 1rem; margin: 0; 
            text-transform: uppercase; letter-spacing: 0.5px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .category-title:first-child { border-top: none; padding-top: 0.5rem; }

        .suggestion-item {
            display: block;
            width: 100%; text-align: left; background: none; border: none;
            color: #cbd5e1;
            padding: 0.6rem 1rem; 
            cursor: pointer;
            font-size: 0.95rem; transition: all 0.2s;
            line-height: 1.5;
        }
        .suggestion-item:hover { 
            background: rgba(255, 255, 255, 0.05);
            color: var(--gold-color, #F2C94C);
        }

        /* === SHUFFLING SCREEN === */
        #shuffling-screen { padding-top: 4rem; justify-content: center; }
        .shuffling-animation-container { position: relative; width: 120px; height: 180px; margin: 3rem auto; }
        .shuffle-card {
            position: absolute;
            width: 100%; height: 100%;
            background-image: url('/card-back.jpg'); background-size: cover;
            border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: shuffle 1.5s ease-in-out infinite;
        }
        .shuffle-card:nth-child(1) { animation-delay: 0s; }
        .shuffle-card:nth-child(2) { animation-delay: -0.5s; }
        .shuffle-card:nth-child(3) { animation-delay: -1s; }
        @keyframes shuffle {
            0%, 100% { transform: translateX(-40px) rotate(-10deg); z-index: 1;}
            50% { transform: translateX(40px) rotate(10deg); z-index: 3;}
        }
        .shuffling-instruction {
            font-size: 1.2rem;
            color: #ccc; text-align: center; line-height: 1.6;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* === DRAWING SCREEN === */
        #drawing-screen { padding-top: 3rem; justify-content: flex-start; }
        .drawing-subheader {
            font-family: var(--font-body);
            color: #fff; font-size: 1.3rem;
            margin-bottom: 2rem; text-align: center; font-weight: 600;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        #chosen-cards-display { display: flex; gap: 1.5rem; justify-content: center; margin-bottom: 3rem; min-height: 180px; }
        .chosen-card-placeholder {
            width: 110px; height: 170px; border: 2px dashed rgba(242, 201, 76, 0.3);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            color: rgba(242, 201, 76, 0.3); font-size: 1.5rem; font-weight: 700; background: rgba(255,255,255,0.02);
        }
        .chosen-card-item { width: 110px; text-align: center; animation: revealCard 0.8s ease; }
        .chosen-card-item img { width: 100%; border-radius: 8px; box-shadow: 0 0 15px rgba(242, 201, 76, 0.2); }
        .chosen-card-item img.reversed { transform: rotate(180deg); }
        .chosen-card-item .card-name { margin-top: 0.5rem; font-weight: 700; color: #fff; font-size: 0.9rem; text-shadow: none; }
        .chosen-card-item .card-orientation { font-size: 0.8rem; color: var(--gold-color, #F2C94C); text-shadow: none; }

        #card-spread-container { display: flex; flex-direction: column; gap: 10px; width: 100%; align-items: center; }
        .card-row { display: flex; justify-content: center; width: 100%; }
        .facedown-card {
            width: 60px; height: 90px; background-image: url('/card-back.jpg'); background-size: cover;
            border-radius: 4px; margin-left: -40px; cursor: pointer; transition: transform 0.3s;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        .facedown-card:hover { transform: translateY(-15px) scale(1.1); z-index: 10; }
        .facedown-card.is-chosen { opacity: 0; pointer-events: none; }
        .mobile-row { display: none; }
        @media (max-width: 768px) {
            #card-row-1, #card-row-2 { display: none; }
            .mobile-row { display: flex; }
            .facedown-card { margin-left: -45px; }
        }

        .action-button {
            display: none;
            opacity: 0; transform: scale(0.9);
            background: linear-gradient(135deg, #D4AF37 0%, #F2C94C 50%, #FFD700 100%);
            color: #050A1F; border: none; padding: 1rem 3rem;
            border-radius: 50px;
            font-size: 1.1rem; font-weight: 700; box-shadow: 0 0 20px rgba(242, 201, 76, 0.4);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .action-button.visible { display: inline-block; opacity: 1; transform: scale(1); }
        .action-button:hover { transform: scale(1.05) translateY(-3px); box-shadow: 0 0 30px rgba(242, 201, 76, 0.8); }

        /* === INTERPRETATION RESULT === */
        #interpretation-results-display {
            display: none;
            width: 100%; max-width: 800px; margin: 2rem auto;
            background: rgba(11, 19, 43, 0.8); border: 1px solid rgba(242, 201, 76, 0.3);
            border-radius: 16px; padding: 2.5rem; backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: left;
        }
        #interpretation-results-display h1, #interpretation-results-display h2, #interpretation-results-display h3 {
            font-family: var(--font-title);
            color: var(--gold-color, #F2C94C);
            margin-top: 1.5rem; margin-bottom: 1rem; text-shadow: none;
        }
        #interpretation-results-display p, #interpretation-results-display li {
            color: #e0e0e0; line-height: 1.8; font-size: 1.05rem; text-shadow: none;
        }
        #interpretation-results-display strong { color: #fff; }

        /* --- LOADER H√ÄNH TINH 3D --- */
        .interpretation-loader {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1.5rem 1rem; perspective: 800px; overflow: hidden;
        }
        .loader-planet-system {
            position: relative; width: 200px; height: 200px; display: flex;
            align-items: center; justify-content: center; transform-style: preserve-3d;
            animation: system-wobble 15s infinite ease-in-out;
        }
        .loader-planet-sphere {
            width: 100px; height: 100px; border-radius: 50%;
            background-image: url('/planet.png'); background-size: cover; background-position: center;
            position: absolute; animation: planet-glow 2.5s infinite ease-in-out;
        }
        .loader-orbit {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; transform-style: preserve-3d;
            animation-iteration-count: infinite; animation-timing-function: linear;
        }
        .orbit-1 { animation: orbit-spin-1 3s linear infinite; }
        .orbit-2 { animation: orbit-spin-2 5s linear infinite; }
        .orbit-3 { animation: orbit-spin-3 7s linear infinite; }
        .orbit-4 { animation: orbit-spin-4 10s linear infinite; }
        .orbit-5 { animation: orbit-spin-5 14s linear infinite; }
        .orbit-1::before, .orbit-2::before, .orbit-3::before, .orbit-4::before, .orbit-5::before {
            content: ''; position: absolute; border-radius: 50%; top: 50%; left: 0;
            transform: translate(-50%, -50%); filter: blur(3px);
        }
        .orbit-1::before { width: 10px; height: 10px; background: #fff; box-shadow: 0 0 15px #fff; }
        .orbit-2::before { width: 7px; height: 7px; background: #ffc; box-shadow: 0 0 15px #ffc; }
        .orbit-3::before { width: 5px; height: 5px; background: #fcc; box-shadow: 0 0 15px #fcc; }
        .orbit-4::before { width: 6px; height: 6px; background: #0ff; box-shadow: 0 0 15px #0ff; }
        .orbit-5::before { width: 8px; height: 8px; background: #f0f; box-shadow: 0 0 15px #f0f; }
        .loader-text {
            margin-top: 1.5rem; font-size: 1.1rem; font-weight: 600;
            color: var(--gold-color, #F2C94C); text-shadow: 0 0 10px rgba(242, 201, 76, 0.3);
            animation: text-fade 2s infinite ease-in-out;
        }

        .loader-note {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #a0aec0; /* M√†u x√°m s√°ng nh·∫π */
            max-width: 90%;
            text-align: center;
            line-height: 1.6;
            opacity: 0; /* ·∫®n ban ƒë·∫ßu */
            animation: fadeIn 1s ease-in-out 1.5s forwards; /* Hi·ªán l√™n sau 1.5s ƒë·ªÉ ƒë·ª° r·ªëi m·∫Øt */
        }
        .loader-note strong {
            color: var(--gold-color, #F2C94C);
            font-weight: 700;

        }
        @keyframes system-wobble { 0%, 100% { transform: rotateY(-10deg) rotateX(5deg); } 50% { transform: rotateY(10deg) rotateX(-5deg); } }
        @keyframes orbit-spin-1 { from { transform: rotateX(65deg) rotateZ(0deg); } to { transform: rotateX(65deg) rotateZ(360deg); } }
        @keyframes orbit-spin-2 { from { transform: rotateX(65deg) rotateY(60deg) rotateZ(0deg); } to { transform: rotateX(65deg) rotateY(60deg) rotateZ(360deg); } }
        @keyframes orbit-spin-3 { from { transform: rotateX(65deg) rotateY(-60deg) rotateZ(0deg); } to { transform: rotateX(65deg) rotateY(-60deg) rotateZ(360deg); } }
        @keyframes orbit-spin-4 { from { transform: rotateX(65deg) rotateY(-45deg) rotateZ(0deg); } to { transform: rotateX(65deg) rotateY(-45deg) rotateZ(360deg); } }
        @keyframes orbit-spin-5 { from { transform: rotateX(65deg) rotateY(30deg) rotateZ(0deg); } to { transform: rotateX(65deg) rotateY(30deg) rotateZ(360deg); } }
        @keyframes text-fade { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        @keyframes planet-glow { 0%, 100% { filter: drop-shadow(0 0 5px #fff); } 50% { filter: drop-shadow(0 0 15px #fff); } }

        /* --- H·ªéI TI·∫æP --- */
        #follow-up-question-container { display: none; width: 100%; max-width: 700px; margin: 3rem auto 0; text-align: center; }
        #follow-up-question-container h3 { font-family: var(--font-title); color: #fff; margin-bottom: 1rem; }

        /* --- FLYING CARD --- */
        .flying-card-animator {
            position: absolute; z-index: 1000; pointer-events: none; width: 60px; height: 90px;
            transition: all 0.8s ease-in-out; transform-style: preserve-3d;
        }
        .flying-card-inner {
            position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s;
        }
        .flying-card-front, .flying-card-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 4px;
        }
        .flying-card-back { background-image: url('/card-back.jpg'); background-size: cover; }
        .flying-card-front { transform: rotateY(180deg); }
        .flying-card-front img { width: 100%; height: 100%; border-radius: 4px; }


        /* ================================================================ */
        /* === 2. STYLE RI√äNG CHO YES/NO (ƒê√É ƒê∆Ø·ª¢C CH·ªàNH THEO THEME M·ªöI) === */
        /* ================================================================ */

        /* === BUTTON CH·ªåN S·ªê L√Å B√ÄI === */
        #reading-options-container {
            width: 100%;
            max-width: 700px; /* Match max-width c·ªßa input area */
            margin: 1.5rem 0 0 0; 
            display: flex;
            /* Glassmorphism background gi·ªëng input area */
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(242, 201, 76, 0.3);
            border-radius: 16px;
            padding: 0.5rem;
            gap: 0.5rem; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .reading-option-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7); /* M√†u ch·ªØ m·ªù khi ch∆∞a active */
            padding: 0.75rem 1rem;
            border-radius: 12px; 
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
        }
        
        .reading-option-btn:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .reading-option-btn.active {
            /* Gradient v√†ng kim gi·ªëng n√∫t Submit */
            background: linear-gradient(135deg, #D4AF37 0%, #F2C94C 50%, #FFD700 100%);
            color: #050A1F; 
            box-shadow: 0 0 15px rgba(242, 201, 76, 0.3);
            text-shadow: none;
            font-weight: 700;
        }

        /* === CSS CHO KHU V·ª∞C TRA C·ª®U B√ÄI === */
        .card-lookup-container {
            width: 100%;
            max-width: 1100px; 
            margin: 3.5rem auto 0 auto; 
            /* Glassmorphism Background */
            background: rgba(11, 19, 43, 0.6);
            border: 1px solid rgba(242, 201, 76, 0.3);
            border-radius: 16px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            text-align: left; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        #card-lookup-container-results {
            max-width: 800px; /* Gi·ªëng max-width c·ªßa k·∫øt qu·∫£ */
            margin-top: 3rem;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        }
        
        .card-lookup-container h2 {
            font-family: var(--font-title);
            color: var(--gold-color, #F2C94C);
            text-align: center; 
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            text-shadow: 0 0 10px rgba(242, 201, 76, 0.3);
        }
        
        #card-search-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 1.5rem;
        }
        
        .card-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #F2C94C; /* Icon m√†u v√†ng */
            opacity: 0.8;
            pointer-events: none;
            font-size: 1rem;
            text-shadow: none;
        }

        .card-search-input {
            width: 100%;
            padding: 0.9rem 1rem 0.9rem 2.75rem;
            background-color: rgba(255, 255, 255, 0.05); /* N·ªÅn t·ªëi/trong su·ªët */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            font-family: var(--font-body);
            font-size: 1rem;
            text-shadow: none;
            transition: all 0.3s;
        }
        .card-search-input:focus {
            outline: none;
            border-color: var(--gold-color, #F2C94C);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(242, 201, 76, 0.1);
        }

        .card-lookup-table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(242, 201, 76, 0.5) rgba(11, 19, 43, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-lookup-table-wrapper::-webkit-scrollbar { width: 8px; }
        .card-lookup-table-wrapper::-webkit-scrollbar-track { background: rgba(11, 19, 43, 0.5); border-radius: 4px; }
        .card-lookup-table-wrapper::-webkit-scrollbar-thumb {
            background-color: rgba(242, 201, 76, 0.5);
            border-radius: 4px;
            border: 2px solid rgba(11, 19, 43, 0.5);
        }
        
        .card-lookup-container table {
            width: 100%;
            border-collapse: collapse;
        }
        
        @media (max-width: 768px) {
            .card-lookup-table-wrapper { overflow-x: auto; }
            .card-lookup-container table { min-width: 850px; }
        }
        
        .card-lookup-container th,
        .card-lookup-container td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-shadow: none; 
            line-height: 1.6;
            font-size: 0.95rem; 
            vertical-align: middle;
            color: #e0e0e0;
        }

        .card-lookup-container th {
            font-family: var(--font-title); /* Font ti√™u ƒë·ªÅ */
            font-weight: 600;
            color: var(--gold-color, #F2C94C); /* M√†u v√†ng */
            position: sticky; 
            top: 0;
            background: #0b132b; /* N·ªÅn ƒë·∫∑c xanh ƒë·∫≠m */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1; 
            letter-spacing: 0.5px;
        }
        
        .card-lookup-container tr:last-child td { border-bottom: none; }
        
        .lookup-card-image {
            width: 60px; height: auto; aspect-ratio: 2/3; 
            object-fit: cover; border-radius: 4px;
            display: block; margin: 0 auto;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        /* Table column widths */
        .card-lookup-container td:nth-child(1) { width: 8%; text-align: center; padding: 0.5rem; }
        .card-lookup-container td:nth-child(2) { width: 22%; font-weight: 700; color: #fff; }
        .card-lookup-container td:nth-child(3) { width: 15%; color: var(--gold-color, #F2C94C); font-weight: 600; } /* C·ªôt Yes/No m√†u v√†ng */
        .card-lookup-container td:nth-child(4) { width: 27.5%; }
        .card-lookup-container td:nth-child(5) { width: 27.5%; }

        /* === NEW STYLES FOR SEO CONTENT === */
        .seo-divider {
            width: 100%;
            max-width: 600px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(242, 201, 76, 0.3), transparent);
            margin: 3rem auto 2rem;
        }

        .seo-guide-container {
            width: 100%;
            max-width: 900px;
            padding: 1rem;
            color: #e0e0e0;
            text-align: left;
        }

        .seo-title {
            font-family: var(--font-title);
            color: var(--gold-color, #F2C94C);
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(242, 201, 76, 0.2);
        }

        .seo-intro {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            line-height: 1.6;
        }

        .seo-tips-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        @media (min-width: 768px) {
            .seo-tips-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .seo-tip-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s;
        }
        .seo-tip-card:hover {
            transform: translateY(-5px);
            border-color: rgba(242, 201, 76, 0.3);
        }

        .tip-title {
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-family: var(--font-title);
        }

        .tip-content {
            font-size: 0.95rem;
            opacity: 0.8;
            line-height: 1.5;
        }

        .seo-examples {
            background: rgba(242, 201, 76, 0.05);
            border-left: 3px solid #F2C94C;
            padding: 1.5rem;
            border-radius: 0 12px 12px 0;
        }

        .example-title {
            color: #F2C94C;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-family: var(--font-title);
        }

        .example-list li {
            margin-bottom: 0.8rem;
            line-height: 1.6;
        }
        .example-list strong {
            color: #fff;
        }
        
    </style>   


    <script>
/* ============================================= */
/* === TAROT.JS (Logic cho trang 1/3 l√°) === */
/* ============================================= */

const N8N_WEBHOOK_URL = 'https://n8n.n8ntuanphangz.xyz/webhook/29fa6319-ca20-42a6-9d31-5a599e1a030d';
const N8N_VALIDATE_URL = 'https://n8n.n8ntuanphangz.xyz/webhook/2b074c1e-6465-4114-872d-c0dcd9278b62'; 
const SHEET_ID = '1Bqu2RBPRH-YeCOiX_5SjmQP8GETpKkqBZhMPZwqm_ig';

// DOM Elements
const screens = document.querySelectorAll('.screen');
const questionInput = document.getElementById('question-input');
const submitQuestionBtn = document.getElementById('submit-question-btn');
const questionErrorDisplay = document.getElementById('question-error-display'); 
// L·∫•y c·∫£ 2 b·∫£ng tra c·ª©u
const cardLookupTable1 = document.getElementById('card-lookup-table-1');
const cardLookupTable2 = document.getElementById('card-lookup-table-2'); 
const cardLookupContainerResults = document.getElementById('card-lookup-container-results'); 
const suggestedQuestionsToggle = document.getElementById('suggested-questions-toggle');
const suggestedQuestionsList = document.getElementById('suggested-questions-list');
const readingOptionBtns = document.querySelectorAll('.reading-option-btn');
const cardRow1 = document.getElementById('card-row-1');
const cardRow2 = document.getElementById('card-row-2');
const cardRow3 = document.getElementById('card-row-3');
const cardRow4 = document.getElementById('card-row-4');
const cardRow5 = document.getElementById('card-row-5');
const cardRow6 = document.getElementById('card-row-6');
const chosenCardsDisplay = document.getElementById('chosen-cards-display'); 
const shufflingQuestionDisplay = document.getElementById('shuffling-question-display');
const drawingQuestionDisplay = document.getElementById('drawing-question-display');
const drawingSubheader = document.querySelector('.drawing-subheader'); 
const getInterpretationButton = document.getElementById('get-interpretation-button');
const mainResultsDisplay = document.getElementById('interpretation-results-display');
const followUpContainer = document.getElementById('follow-up-question-container');
const followUpInput = document.getElementById('follow-up-question-input');
const followUpSubmitBtn = document.getElementById('submit-follow-up-btn');
const followUpErrorDisplay = document.getElementById('follow-up-error-display');

// Icon HTML
const sendIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
</svg>`;
const spinnerIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="animate-spin" width="20" height="20">
    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
</svg>`;

// State
let cardData = [];
let selectedCards = [];
let userQuestion = '';
let isAnimating = false;
let allCardImagesLoaded = false;
let currentReadingId = null; 
let numCardsToChoose = 1; 
let cardMeaningsHtml = '';
// Bi·∫øn l∆∞u tr·ªØ HTML c·ªßa b·∫£ng

// === Functions ===

/** Auto-grow textarea */
function autoGrow(element) {
    if (!element) return;
    element.style.height = 'auto'; 
    element.style.height = Math.max(56, element.scrollHeight) + 'px'; 
}

/** Chuy·ªÉn m√†n h√¨nh */
function showScreen(screenId) {
    screens.forEach(screen => screen.classList.remove('active'));
    const activeScreen = document.getElementById(screenId);
    if (activeScreen) {
        activeScreen.classList.add('active');
    }
}

/** T·∫£i d·ªØ li·ªáu 78 l√° b√†i */
async function initialize() {
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Cards&tqx=out:json&tq=SELECT%20*%20OFFSET%201`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const table = JSON.parse(jsonText).table;
        cardData = table.rows.map((row, index) => ({
            id: index,
            name: row.c[0]?.v || 'Unknown Card',
            image: row.c[1]?.v || 'https://placehold.co/200x340'
        }));
        preloadAllCardImages();
    } catch (error)
    {
        console.error("L·ªói khi t·∫£i l√° b√†i:", error);
        if (document.getElementById('card-spread-container')) {
             document.getElementById('card-spread-container').innerHTML = '<p>L·ªói t·∫£i b·ªô b√†i. Vui l√≤ng t·∫£i l·∫°i trang.</p>';
        }
    }
}

/** T·∫£i v√† hi·ªÉn th·ªã d·ªØ li·ªáu tra c·ª©u */
async function loadCardMeanings() {
    const loadingHtml = '<p style="padding: 1rem; opacity: 0.7; text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu tra c·ª©u...</p>';
    if (cardLookupTable1) cardLookupTable1.innerHTML = loadingHtml;
    if (cardLookupTable2) cardLookupTable2.innerHTML = loadingHtml;
    
    // N·∫øu ƒë√£ t·∫£i r·ªìi, ch·ªâ c·∫ßn hi·ªÉn th·ªã
    if (cardMeaningsHtml) {
        if (cardLookupTable1) cardLookupTable1.innerHTML = cardMeaningsHtml;
        if (cardLookupTable2) cardLookupTable2.innerHTML = cardMeaningsHtml;
        return;
    }

    try {
        const sheetName = 'YesNo_Meaning';
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheetName}&tqx=out:json&tq=SELECT%20A,%20B,%20C,%20D,%20E%20OFFSET%201`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}. L·ªói khi t·∫£i tab '${sheetName}'.`);
        const text = await response.text();
        
        if (text.startsWith('<!DOCTYPE html>')) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y tab '${sheetName}' ho·∫∑c l·ªói truy c·∫≠p Google Sheet.`);
        }
        
        const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const data = JSON.parse(jsonText);

        if (data.status === 'error') {
            let errorMsg = data.errors.map(e => e.detailed_message).join(', ');
            if (errorMsg.includes('Unable to parse query') || errorMsg.includes('Invalid sheet')) {
                 throw new Error(`L·ªói GVIZ: Kh√¥ng t√¨m th·∫•y tab t√™n l√† '${sheetName}'. Vui l√≤ng ki·ªÉm tra l·∫°i t√™n tab trong Google Sheet.`);
            }
             if (errorMsg.includes('SELECT_E')) {
                 throw new Error(`L·ªói GVIZ: Kh√¥ng t√¨m th·∫•y C·ªôt E trong tab '${sheetName}'. Vui l√≤ng th√™m c·ªôt E ch·ª©a URL h√¨nh ·∫£nh.`);
            }
            throw new Error(`L·ªói GVIZ: ${errorMsg}`);
        }

        const table = data.table;
        const rows = table.rows;
        if (rows.length === 0) {
            cardMeaningsHtml = '<p style="padding: 1rem; opacity: 0.7; text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu tra c·ª©u.</p>';
            if (cardLookupTable1) cardLookupTable1.innerHTML = cardMeaningsHtml;
            if (cardLookupTable2) cardLookupTable2.innerHTML = cardMeaningsHtml;
            return;
        }

        let html = '<div class="card-lookup-table-wrapper"><table>';
        html += `
            <thead>
                <tr>
                    <th colspan="2">L√° b√†i Tarot</th> 
                    <th>√ù nghƒ©a Yes/No</th>
                    <th>√ù nghƒ©a Xu√¥i</th>
                    <th>√ù nghƒ©a Ng∆∞·ª£c</th>
                </tr>
            </thead>
            <tbody>
        `;
        rows.forEach(row => {
            const cardName = row.c[0]?.v || 'N/A';
            const yesNo = row.c[1]?.v || 'N/A';
            const upright = row.c[2]?.v || 'N/A';
            const reversed = row.c[3]?.v || 'N/A';
            const imageUrl = row.c[4]?.v || 'https://placehold.co/60x100?text=?'; 
            
            html += `
                <tr>
                    <td><img src="${imageUrl}" alt="${cardName}" class="lookup-card-image" loading="lazy"></td> 
                    <td><strong>${cardName}</strong></td>
                    <td>${yesNo}</td>
                    <td>${upright}</td>
                    <td>${reversed}</td>
                </tr>
            `;
        });
        html += '</tbody></table></div>'; 
        
        // L∆∞u HTML v√†o bi·∫øn cache
        cardMeaningsHtml = html;
        // Hi·ªÉn th·ªã HTML ·ªü c·∫£ 2 b·∫£ng
        if (cardLookupTable1) cardLookupTable1.innerHTML = cardMeaningsHtml;
        if (cardLookupTable2) cardLookupTable2.innerHTML = cardMeaningsHtml;

    } catch (error) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu tra c·ª©u b√†i:", error);
        const errorHtml = `<p style="padding: 1rem; opacity: 0.7; text-align: center; color: #ff8a8a;">L·ªói t·∫£i d·ªØ li·ªáu tra c·ª©u: ${error.message}<br>Vui l√≤ng ƒë·∫£m b·∫£o Google Sheet c√≥ m·ªôt tab t√™n l√† 'Meanings' (ƒë√£ th√™m C·ªôt E) v√† ƒë√£ ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.</p>`;
        if (cardLookupTable1) cardLookupTable1.innerHTML = errorHtml;
        if (cardLookupTable2) cardLookupTable2.innerHTML = errorHtml;
    }
}

/** H√†m l·ªçc b·∫£ng tra c·ª©u */
function filterCardTable(event) {
    const searchInput = event.target;
    if (!searchInput) return;
    
    // 1. L·∫•y target table ID t·ª´ data-target
    const targetTableId = searchInput.dataset.target;
    if (!targetTableId) return;
    
    const targetTableContainer = document.getElementById(targetTableId);
    if (!targetTableContainer) return;
    // 2. L·∫•y c·ª•m t·ª´ t√¨m ki·∫øm
    const searchTerm = searchInput.value.toLowerCase().trim();
    // 3. T√¨m t·∫•t c·∫£ c√°c h√†ng <tr> trong <tbody> C·ª¶A B·∫¢NG ƒê√ì
    const tableRows = targetTableContainer.querySelectorAll('tbody tr');
    // 4. Ki·ªÉm tra ƒëi·ªÅu ki·ªán (√≠t nh·∫•t 3 k√Ω t·ª±)
    if (searchTerm.length >= 3) {
        // 5. L·∫∑p qua t·ª´ng h√†ng
        tableRows.forEach(row => {
            const cardNameCell = row.querySelector('td:nth-child(2)'); 
            if (cardNameCell) {
                const cardName = cardNameCell.textContent.toLowerCase();
                
                if (cardName.includes(searchTerm)) {
                    row.style.display = ""; 
                } else {
                    row.style.display = "none"; 
                }
            }
        });
    } else {
        // 6. N·∫øu d∆∞·ªõi 3 k√Ω t·ª±, hi·ªán t·∫•t c·∫£ c√°c h√†ng
        tableRows.forEach(row => {
            row.style.display = "";
        });
    }
}


/** T·∫£i c√¢u h·ªèi g·ª£i √Ω */
async function loadSuggestedQuestions() {
    if (!suggestedQuestionsList) return;
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=YnQuestions&tqx=out:json&tq=SELECT%20A,%20B%20OFFSET%201`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        const table = JSON.parse(jsonText).table;

        const rawData = table.rows.map(row => ({
            category: row.c[0]?.v,
            question: row.c[1]?.v
        }));
        const grouped = {};
        rawData.forEach(item => {
            if (!item.category || !item.question) return; 
            if (!grouped[item.category]) {
                grouped[item.category] = [];
            }
            grouped[item.category].push(item.question);
        });
        renderSuggestedQuestions(grouped);

    } catch (error) {
        console.error("L·ªói khi t·∫£i c√¢u h·ªèi g·ª£i √Ω:", error);
        suggestedQuestionsList.innerHTML = '<p style="padding: 1rem; opacity: 0.7; text-align: center;">Kh√¥ng th·ªÉ t·∫£i g·ª£i √Ω.</p>';
    }
}

/** Hi·ªÉn th·ªã c√¢u h·ªèi g·ª£i √Ω */
function renderSuggestedQuestions(groupedData) {
    if (!suggestedQuestionsList) return;
    let html = '';
    for (const category in groupedData) {
        html += `<h4 class="category-title">${category}</h4>`;
        groupedData[category].forEach(question => {
            const safeQuestion = question.replace(/"/g, '&quot;');
            html += `<button class="suggestion-item" data-question="${safeQuestion}">${question}</button>`;
        });
    }
    suggestedQuestionsList.innerHTML = html;
}

/** T·∫£i tr∆∞·ªõc h√¨nh ·∫£nh 78 l√° b√†i */
function preloadAllCardImages() {
    if (!cardData || cardData.length === 0) return;

    console.log("B·∫Øt ƒë·∫ßu t·∫£i tr∆∞·ªõc 78 h√¨nh ·∫£nh l√° b√†i...");
    const imagePromises = cardData.map(card => {
        return new Promise((resolve) => { 
            const img = new Image();
            img.src = card.image;
            img.onload = resolve;
            img.onerror = resolve; 
        });
    });

    Promise.all(imagePromises)
        .then(() => {
            allCardImagesLoaded = true;
            console.log("T·∫•t c·∫£ 78 h√¨nh ·∫£nh l√° b√†i ƒë√£ ƒë∆∞·ª£c t·∫£i tr∆∞·ªõc!");
        })
        .catch(err => {
            console.error("L·ªói trong qu√° tr√¨nh t·∫£i tr∆∞·ªõc h√¨nh ·∫£nh:", err);
            allCardImagesLoaded = true; 
        });
}

/** X·ª≠ l√Ω khi n·ªôp c√¢u h·ªèi ƒë·∫ßu ti√™n */
async function handleQuestionSubmit() {
    const questionFromInput = questionInput.value.trim();
    questionErrorDisplay.textContent = ''; 
    questionErrorDisplay.style.color = '#ff8a8a'; 

    if (!questionFromInput) {
        const inputArea = document.getElementById('question-input-area');
        inputArea.style.animation = 'shake 0.5s ease';
        setTimeout(() => { inputArea.style.animation = ''; }, 500);
        return;
    }
    
    submitQuestionBtn.disabled = true;
    submitQuestionBtn.innerHTML = spinnerIcon;
    questionErrorDisplay.textContent = 'ƒêang ki·ªÉm tra c√¢u h·ªèi c·ªßa b·∫°n...'; 
    questionErrorDisplay.style.color = '#d4af37';
    try {
        const response = await fetch(N8N_VALIDATE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: questionFromInput })
        });
        if (N8N_VALIDATE_URL.includes('YOUR-VALIDATION-WEBHOOK-ID')) {
             throw new Error('Vui l√≤ng thay th·∫ø URL N8N_VALIDATE_URL');
        }
        
        if (!response.ok) {
            throw new Error('L·ªói t·ª´ m√°y ch·ªß x√°c th·ª±c.');
        }

        const n8nResponse = await response.json();
        const validationResult = n8nResponse;
        if (validationResult && (validationResult.isValid === "true" || validationResult.isValid === true)) {
            userQuestion = questionFromInput;
            currentReadingId = crypto.randomUUID(); 
            startNewReadingFlow();
            submitQuestionBtn.disabled = false;
            submitQuestionBtn.innerHTML = sendIcon;
        } else {
            questionErrorDisplay.textContent = validationResult?.reason || 'C√¢u h·ªèi kh√¥ng h·ª£p l·ªá.';
            questionErrorDisplay.style.color = '#ff8a8a'; 
            submitQuestionBtn.disabled = false;
            submitQuestionBtn.innerHTML = sendIcon;
        }

    } catch (error) {
        console.error("L·ªói khi x√°c th·ª±c c√¢u h·ªèi:", error);
        if (error.message.includes('URL')) {
            questionErrorDisplay.textContent = 'L·ªói: B·∫°n ch∆∞a c·∫≠p nh·∫≠t N8N_VALIDATE_URL trong code.';
        } else {
            questionErrorDisplay.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.';
        }
        questionErrorDisplay.style.color = '#ff8a8a'; 
        submitQuestionBtn.disabled = false;
        submitQuestionBtn.innerHTML = sendIcon;
    }
}

/** X·ª≠ l√Ω khi n·ªôp c√¢u h·ªèi ti·∫øp theo */
async function handleFollowUpSubmit() {
    const questionFromInput = followUpInput.value.trim();
    followUpErrorDisplay.textContent = ''; 
    followUpErrorDisplay.style.color = '#ff8a8a'; 

    if (!questionFromInput) {
        const inputArea = document.getElementById('follow-up-input-area');
        inputArea.style.animation = 'shake 0.5s ease';
        setTimeout(() => { inputArea.style.animation = ''; }, 500);
        return;
    }
    
    followUpSubmitBtn.disabled = true;
    followUpSubmitBtn.innerHTML = spinnerIcon;
    followUpErrorDisplay.textContent = 'ƒêang ki·ªÉm tra c√¢u h·ªèi c·ªßa b·∫°n...'; 
    followUpErrorDisplay.style.color = '#d4af37';
    try {
        const response = await fetch(N8N_VALIDATE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: questionFromInput })
        });
        if (N8N_VALIDATE_URL.includes('YOUR-VALIDATION-WEBHOOK-ID')) {
             throw new Error('Vui l√≤ng thay th·∫ø URL N8N_VALIDATE_URL');
        }

        if (!response.ok) {
            throw new Error('L·ªói t·ª´ m√°y ch·ªß x√°c th·ª±c.');
        }

        const n8nResponse = await response.json();
        const validationResult = n8nResponse;
        if (validationResult && (validationResult.isValid === "true" || validationResult.isValid === true)) {
            userQuestion = questionFromInput;
            followUpInput.value = '';
            currentReadingId = crypto.randomUUID(); 
            startNewReadingFlow();
            followUpSubmitBtn.disabled = false;
            followUpSubmitBtn.innerHTML = sendIcon;
        } else {
            followUpErrorDisplay.textContent = validationResult?.reason || 'C√¢u h·ªèi kh√¥ng h·ª£p l·ªá.';
            followUpErrorDisplay.style.color = '#ff8a8a'; 
            followUpSubmitBtn.disabled = false;
            followUpSubmitBtn.innerHTML = sendIcon;
        }

    } catch (error) {
        console.error("L·ªói khi x√°c th·ª±c c√¢u h·ªèi (h·ªèi ti·∫øp):", error);
        if (error.message.includes('URL')) {
            followUpErrorDisplay.textContent = 'L·ªói: B·∫°n ch∆∞a c·∫≠p nh·∫≠t N8N_VALIDATE_URL trong code.';
        } else {
            followUpErrorDisplay.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.';
        }
        followUpErrorDisplay.style.color = '#ff8a8a'; 
        followUpSubmitBtn.disabled = false;
        followUpSubmitBtn.innerHTML = sendIcon;
    }
}

/** Ti√™m CSS cho hi·ªáu ·ª©ng rung l·∫Øc */
const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = `@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }`;
document.head.appendChild(styleSheet);


/** B·∫Øt ƒë·∫ßu m·ªôt l∆∞·ª£t tr·∫£i b√†i m·ªõi */
function startNewReadingFlow() {
    sessionStorage.removeItem('tarotSession');
    shufflingQuestionDisplay.textContent = userQuestion;
    drawingQuestionDisplay.textContent = userQuestion;
    showScreen('shuffling-screen');

    const shuffleTime = 2500; 
    const startTime = Date.now();
    function checkAndProceed() {
        const elapsedTime = Date.now() - startTime;
        const timeRemaining = shuffleTime - elapsedTime;

        if (allCardImagesLoaded && timeRemaining <= 0) {
            populateCardDeck();
            showScreen('drawing-screen');
        } else {
            const nextCheck = allCardImagesLoaded ? timeRemaining : 100;
            setTimeout(checkAndProceed, Math.max(nextCheck, 0)); 
        }
    }

    checkAndProceed();
}

/** T·∫°o b·ªô b√†i 78 l√° √∫p */
function populateCardDeck() {
    cardRow1.innerHTML = '';
    cardRow2.innerHTML = '';
    cardRow3.innerHTML = '';
    cardRow4.innerHTML = '';
    cardRow5.innerHTML = '';
    cardRow6.innerHTML = '';
    selectedCards = []; 
    mainResultsDisplay.style.display = 'none';
    mainResultsDisplay.innerHTML = '';

    if (drawingSubheader) {
        drawingSubheader.textContent = `H√£y ch·ªçn ${numCardsToChoose} l√° b√†i`;
    }
    updateChosenCardsDisplay(); 

    const drawingScreen = document.getElementById('drawing-screen');
    drawingScreen.classList.remove('results-active');
    
    getInterpretationButton.classList.remove('visible');
    getInterpretationButton.style.display = 'none';
    
    followUpContainer.style.display = 'none';
    followUpInput.value = '';
    followUpErrorDisplay.textContent = ''; 
    questionInput.value = ''; 

    for (let i = 0; i < 78; i++) {
        const cardElementDesktop = document.createElement('div');
        cardElementDesktop.className = 'facedown-card';
        cardElementDesktop.dataset.positionIndex = i;
        cardElementDesktop.style.animation = `dealCardIn 0.3s ease-out forwards ${i * 30}ms`;
        
        const cardElementMobile = cardElementDesktop.cloneNode(true);
        const animationEndCallback = (e) => {
            if (e.animationName === 'dealCardIn') {
                e.target.classList.add('is-dealt');
                e.target.style.animation = ''; 
            }
        };
        cardElementDesktop.addEventListener('animationend', animationEndCallback);
        cardElementMobile.addEventListener('animationend', animationEndCallback);
        const clickHandler = (e) => handleCardSelection(e, e.currentTarget);
        cardElementDesktop.addEventListener('click', clickHandler);
        cardElementMobile.addEventListener('click', clickHandler);
        

        if (i < 39) {
            cardRow1.appendChild(cardElementDesktop);
        } else {
            cardRow2.appendChild(cardElementDesktop);
        }
        
        if (i < 20) {
            cardRow3.appendChild(cardElementMobile);
        } else if (i < 40) {
            cardRow4.appendChild(cardElementMobile);
        } else if (i < 60) {
            cardRow5.appendChild(cardElementMobile);
        } else {
            cardRow6.appendChild(cardElementMobile);
        }
    }
}

/** X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn 1 l√° b√†i */
function handleCardSelection(event, clickedElement) {
    event.preventDefault();
    if (selectedCards.length >= numCardsToChoose || isAnimating) return; 

    const posIndex = clickedElement.dataset.positionIndex;
    const allCardsWithIndex = document.querySelectorAll(`.facedown-card[data-position-index="${posIndex}"]`);

    let alreadyChosen = false;
    allCardsWithIndex.forEach(card => {
        if (card.classList.contains('is-chosen')) {
            alreadyChosen = true;
        }
    });
    if (alreadyChosen) return;

    isAnimating = true; 

    allCardsWithIndex.forEach(card => card.classList.add('is-chosen'));

    const availableCards = cardData.filter(card => !selectedCards.some(sc => sc.id === card.id));
    const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
    const isReversed = Math.random() < 0.5;
    const orientation = isReversed ? 'Ng∆∞·ª£c' : 'Xu√¥i';
    const chosenCard = { ...randomCard, isReversed, orientation };

    const targetPlaceholder = document.querySelectorAll('#chosen-cards-display .chosen-card-placeholder')[0];
    if (targetPlaceholder) {
        animateCardFlight(clickedElement, targetPlaceholder, chosenCard);
    } else {
        isAnimating = false;
    }
}

/** Hi·ªáu ·ª©ng l√° b√†i bay */
function animateCardFlight(startEl, endEl, cardData) {
    
    const img = new Image();
    const onImageLoaded = () => {
        const startRect = startEl.getBoundingClientRect();
        const endRect = endEl.getBoundingClientRect();
        
        const flyingCard = document.createElement('div');
        flyingCard.className = 'flying-card-animator';
        
        const reversedClass = cardData.isReversed ? 'reversed' : '';
        flyingCard.innerHTML = `
            <div class="flying-card-inner">
                <div class="flying-card-back"></div>
                <div class="flying-card-front">
                    <img src="${cardData.image}" alt="${cardData.name}" class="${reversedClass}">
                </div>
            
            </div>
        `;
        
        flyingCard.style.top = `${startRect.top + window.scrollY}px`;
        flyingCard.style.left = `${startRect.left}px`;
        flyingCard.style.width = `${startRect.width}px`;
        flyingCard.style.height = `${startRect.height}px`;
        
        document.body.appendChild(flyingCard);
        
        requestAnimationFrame(() => {
            const inner = flyingCard.querySelector('.flying-card-inner');
            
            flyingCard.style.top = `${endRect.top + window.scrollY}px`;
            flyingCard.style.left = `${endRect.left}px`;
            flyingCard.style.width = `${endRect.width}px`;
            flyingCard.style.height = `${endRect.height}px`;
            
            inner.style.transform = 'rotateY(180deg) translateZ(0)';
        });
        let flightHasEnded = false;
        
        const onFlightEnd = (event) => {
            if (event.target !== flyingCard || flightHasEnded) {
                return;
            }
            flightHasEnded = true; 

            flyingCard.removeEventListener('transitionend', onFlightEnd);
            flyingCard.remove(); 
            
            selectedCards.push(cardData);
            updateChosenCardsDisplay();
            if (selectedCards.length === numCardsToChoose) {
                transitionToResultsView();
            }
            
            isAnimating = false;
        };
        
        flyingCard.addEventListener('transitionend', onFlightEnd);
    };

    img.onload = onImageLoaded; 
    img.onerror = onImageLoaded; 
    img.src = cardData.image;
}


/** C·∫≠p nh·∫≠t khu v·ª±c c√°c l√° b√†i ƒë√£ ch·ªçn */
function updateChosenCardsDisplay() {
    chosenCardsDisplay.innerHTML = '';
    let cardItemElements = []; 
    
    selectedCards.forEach(card => {
        const cardItem = document.createElement('div');
        cardItem.className = 'chosen-card-item';
        cardItem.innerHTML = `
            <div class="card-image-wrapper">
                <img src="${card.image}" alt="${card.name}" class="${card.isReversed ? 'reversed' : ''}">
            </div>
            <div class="card-info">
                <div class="card-name">${card.name}</div>
                ${card.isReversed ? '<div class="card-orientation">(L√° b√†i Ng∆∞·ª£c)</div>' : ''}
            </div>
        `;
        cardItemElements.push(cardItem); 
    });
    cardItemElements.forEach(item => {
        chosenCardsDisplay.appendChild(item);
        setTimeout(() => {
            item.style.opacity = '1';
        }, 0);
    });
    for (let i = 0; i < numCardsToChoose - selectedCards.length; i++) {
        chosenCardsDisplay.innerHTML += '<div class="chosen-card-placeholder"></div>';
    }
}

/** Chuy·ªÉn sang tr·∫°ng th√°i xem k·∫øt qu·∫£ */
function transitionToResultsView() {
    const drawingScreen = document.getElementById('drawing-screen');
    drawingScreen.classList.add('results-active');
    getInterpretationButton.style.display = 'inline-block'; 
    setTimeout(() => {
        getInterpretationButton.classList.add('visible');
    }, 300);
}

/** L·∫•y lu·∫≠n gi·∫£i t·ª´ AI */
async function handleGetInterpretation() {
    mainResultsDisplay.style.display = 'block';
    mainResultsDisplay.innerHTML = `
        <div class="interpretation-loader">
            <div class="loader-planet-system">
                <div class="loader-planet-sphere"></div>
                <div class="loader-orbit orbit-1"></div>
                <div class="loader-orbit orbit-2"></div>
                <div class="loader-orbit orbit-3"></div>
                <div class="loader-orbit orbit-4"></div>
                <div class="loader-orbit orbit-5"></div>
            </div>
            <p class="loader-text">ƒêang lu·∫≠n gi·∫£i, v≈© tr·ª• ƒëang tr·∫£ l·ªùi...</p>
            <div class="loader-note">
                <p style="margin-bottom: 5px;">‚ú® V√¨ t√≠n hi·ªáu v≈© tr·ª• g·ª≠i v·ªÅ qu√° nhi·ªÅu n√™n c√≥ th·ªÉ h∆°i "lag" x√≠u, mong b·∫°n th√¥ng c·∫£m nha.</p>
                <p>N·∫øu ch·ªù qu√° l√¢u, h√£y <strong>Inbox 3 l√° b√†i b·∫°n ch·ªçn</strong> (T√™n l√° + Chi·ªÅu Xu√¥i/Ng∆∞·ª£c) cho ch√∫ng m√¨nh. Ph·ªü G√µ Tarot s·∫Ω gi·∫£i m√£ <strong>Free</strong> ph·∫£n h·ªìi ri√™ng cho b·∫°n!</p>
            </div>
        </div>
    `;
    getInterpretationButton.classList.remove('visible');
    setTimeout(() => {
        getInterpretationButton.style.display = 'none';
    }, 300);
    const payload = {
        question: userQuestion,
        cards: selectedCards.map(c => ({ name: c.name, orientation: c.orientation })),
        readingId: currentReadingId 
    };
    try {
        const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`L·ªói t·ª´ server: ${response.statusText}`);

        const result = await response.json();
        if (result && result.interpretation) {
            const converter = new showdown.Converter();
            const markdownContent = result.interpretation; 
            const htmlContent = converter.makeHtml(markdownContent);
            mainResultsDisplay.innerHTML = htmlContent; 

            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = htmlContent;
            const plainTextContent = (tempDiv.textContent || tempDiv.innerText || "").trim();

            const fullEntry = { 
                readingId: currentReadingId, 
                timestamp: Date.now(), 
                question: userQuestion, 
                cards: selectedCards, 
                html: htmlContent, 
                text: plainTextContent, 
                markdown: markdownContent 
            };
            if (typeof saveHistory === 'function') {
                saveHistory(fullEntry);
            } else {
                console.error("L·ªói: Kh√¥ng t√¨m th·∫•y h√†m saveHistory().");
            }

        } else {
            throw new Error("D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.");
        }
    } catch (error) {
        console.error("L·ªói khi g·ªçi Webhook:", error);
        mainResultsDisplay.innerHTML = `<p>ƒê√£ x·∫£y ra l·ªói: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i sau.</p>`;
    }
    
    mainResultsDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
    followUpContainer.style.display = 'block';
    // Hi·ªÉn th·ªã b·∫£ng tra c·ª©u c√πng l√∫c v·ªõi k·∫øt qu·∫£ v√† c√¢u h·ªèi ti·∫øp
    if (cardLookupContainerResults) {
        cardLookupContainerResults.style.display = 'block';
    }
}

/** T·∫£i tr·∫°ng th√°i ban ƒë·∫ßu */
function loadSessionState() {
    showScreen('question-screen');
}


// === Event Listeners (Game-specific) ===
document.addEventListener('DOMContentLoaded', async () => {
    if (document.getElementById('question-screen')) {
        // Init game
        await initialize(); 
        await loadSuggestedQuestions(); 
        await loadCardMeanings(); // T·∫£i b·∫£ng tra c·ª©u (h√†m n√†y s·∫Ω t·ª± ƒëi·ªÅn cho c·∫£ 2 b·∫£ng)
        loadSessionState(); 

        // Auto-grow textareas
        questionInput.addEventListener('input', () => autoGrow(questionInput));
        followUpInput.addEventListener('input', () => autoGrow(followUpInput));
        
        // G·∫Øn listener cho T·∫§T C·∫¢ thanh t√¨m ki·∫øm
        const cardSearchInputs = document.querySelectorAll('.card-search-input');
        if (cardSearchInputs.length > 0) {
            cardSearchInputs.forEach(input => {
                input.addEventListener('input', filterCardTable);
            });
        }

        // Enter key listeners
        questionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleQuestionSubmit();
            }
        });
        followUpInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handleFollowUpSubmit();
            }
        });
        // Button click listeners
        submitQuestionBtn.addEventListener('click', handleQuestionSubmit);
        suggestedQuestionsToggle.addEventListener('click', () => {
            suggestedQuestionsList.classList.toggle('open');
            suggestedQuestionsToggle.classList.toggle('open');
        });
        suggestedQuestionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                questionInput.value = e.target.dataset.question;
                autoGrow(questionInput);
                suggestedQuestionsList.classList.remove('open');
                suggestedQuestionsToggle.classList.remove('open');
            }
        });
        
        readingOptionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                readingOptionBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                numCardsToChoose = parseInt(btn.dataset.value, 10);
                console.log("S·ªë l√° b√†i ƒë∆∞·ª£c ch·ªçn: ", numCardsToChoose);
                
                // C·∫≠p nh·∫≠t subheader ngay khi ch·ªçn
                if (drawingSubheader) {
                    drawingSubheader.textContent = `H√£y ch·ªçn ${numCardsToChoose} l√° b√†i`;
                }
            });
        });
        // ƒê√≥ng dropdown khi click ra ngo√†i
        document.addEventListener('click', (e) => {
            if (suggestedQuestionsToggle && !suggestedQuestionsToggle.contains(e.target) && !suggestedQuestionsList.contains(e.target)) {
                suggestedQuestionsList.classList.remove('open');
                suggestedQuestionsToggle.classList.remove('open');
            }
        });
        getInterpretationButton.addEventListener('click', handleGetInterpretation);
        followUpSubmitBtn.addEventListener('click', handleFollowUpSubmit);
    }
});
    </script>
</BaseLayout>