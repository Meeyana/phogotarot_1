<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>✨ AI Art Studio</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* --- CSS Variables & Reset --- */
    :root {
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --danger-color: #ef4444;
      --danger-hover: #dc2626;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;
      --radius: 12px;
      --copy-bg: #f3f4f6;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }

    /* --- Main Container --- */
    .ai-gen-container {
      width: 100%;
      max-width: 850px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    /* Header */
    .header { text-align: center; margin-bottom: 10px; }
    .header h1 { margin: 0 0 8px; font-size: 26px; color: var(--text-main); letter-spacing: -0.5px; }
    .header p { margin: 0; color: var(--text-muted); font-size: 15px; }

    /* Form Elements */
    .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 18px; }
    .form-label { font-weight: 600; font-size: 14px; color: #374151; }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
      background-color: #fff;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-textarea { resize: vertical; min-height: 120px; line-height: 1.5; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
      gap: 8px;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { background-color: #a5a3e6; cursor: not-allowed; transform: none; }

    .btn-danger { background-color: white; color: var(--danger-color); border: 1px solid #fee2e2; margin-top: 12px; }
    .btn-danger:hover { background-color: #fef2f2; border-color: #fca5a5; }

    /* Copy Button Style */
    .btn-copy {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--copy-bg);
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-muted);
      font-family: monospace;
      transition: all 0.2s;
      max-width: 100%;
    }
    .btn-copy:hover { background: #e5e7eb; color: var(--text-main); border-color: #d1d5db; }
    .btn-copy svg { width: 14px; height: 14px; opacity: 0.7; }
    .btn-copy.copied { background: #dcfce7; color: #166534; border-color: #bbf7d0; }

    /* --- Result Area --- */
    .result-area {
      border-top: 1px solid var(--border-color);
      padding-top: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 240px;
      justify-content: center;
    }

    .image-wrapper {
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      background: #f3f4f6;
      margin-bottom: 16px;
      position: relative;
      min-height: 200px; /* Placeholder height */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-wrapper img {
      width: 100%;
      height: auto;
      display: block;
      max-height: 600px;
      object-fit: contain;
    }

    /* States */
    .state-msg { text-align: center; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .state-error { color: var(--danger-color); background: #fef2f2; padding: 16px; border-radius: 8px; width: 100%; text-align: center; border: 1px solid #fecaca; }

    /* Loading Spinner */
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Utility */
    .hidden { display: none !important; }
    .toolbar { width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }

    /* Responsive */
    @media (min-width: 768px) {
      .ai-gen-container {
        flex-direction: row;
        align-items: flex-start;
      }
      .col-left { flex: 1; width: 100%; }
      .col-right { flex: 1.2; width: 100%; } /* Bên phải rộng hơn chút để hiển thị ảnh đẹp */
      .result-area { 
        border-top: none; 
        padding-top: 0; 
        padding-left: 32px; 
        border-left: 1px solid var(--border-color);
        height: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>

  <div class="ai-gen-container">
    
    <!-- Cột trái: Input Form -->
    <div class="col-left">
      <div class="header">
        <h1>AI Art Studio</h1>
        <p>Sáng tạo hình ảnh với Gemini & Imagen</p>
      </div>

      <form id="generateForm">
        <div class="form-group">
          <label class="form-label">Ý tưởng của bạn</label>
          <textarea id="promptInput" class="form-textarea" placeholder="Mô tả chi tiết bức tranh bạn muốn vẽ..." required></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Chế độ xử lý</label>
          <select id="modelSelect" class="form-select">
            <option value="imagen-4.0-generate-001">Chất lượng cao (Imagen 4.0)</option>
            <option value="gemini-2.5-flash-image">Tốc độ nhanh (Gemini 2.5)</option>
          </select>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
          <span>Bắt đầu tạo ảnh</span>
        </button>
      </form>
    </div>

    <!-- Cột phải: Kết quả -->
    <div class="col-right result-area">
      
      <!-- State: Empty -->
      <div id="stateEmpty" class="state-msg">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        <p>Tác phẩm của bạn sẽ xuất hiện tại đây</p>
      </div>

      <!-- State: Loading -->
      <div id="stateLoading" class="state-msg hidden">
        <div class="spinner"></div>
        <p>AI đang vẽ tranh, vui lòng đợi...</p>
      </div>

      <!-- State: Error -->
      <div id="stateError" class="state-error hidden">
        <strong>Rất tiếc!</strong> <br> <span id="errorText" style="font-size: 14px;">Đã xảy ra lỗi xử lý</span>
      </div>

      <!-- State: Success -->
      <div id="stateSuccess" class="hidden" style="width: 100%;">
        <div class="image-wrapper">
          <img id="resultImage" src="" alt="AI Generated Image">
        </div>
        
        <div class="toolbar">
          <!-- Nút Copy ID -->
          <button id="copyIdBtn" class="btn-copy" title="Sao chép ID hình ảnh">
            <svg id="iconCopy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
            <svg id="iconCheck" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            <span id="fileIdText">ID...</span>
          </button>
          
          <button id="deleteBtn" class="btn btn-danger" style="width: auto; margin-top:0; padding: 8px 12px; font-size: 13px;">
            Xóa hình ảnh
          </button>
        </div>
      </div>

    </div>

  </div>

  <script>
    // --- CẤU HÌNH API ---
    const WEBHOOK_GENERATE = "https://n8n.n8ntuanphangz.xyz/webhook/get-prompt";
    const WEBHOOK_DELETE   = "https://n8n.n8ntuanphangz.xyz/webhook/delete-image";

    // Elements
    const form = document.getElementById('generateForm');
    const promptInput = document.getElementById('promptInput');
    const modelSelect = document.getElementById('modelSelect');
    const submitBtn = document.getElementById('submitBtn');
    
    const stateEmpty = document.getElementById('stateEmpty');
    const stateLoading = document.getElementById('stateLoading');
    const stateError = document.getElementById('stateError');
    const stateSuccess = document.getElementById('stateSuccess');
    
    const resultImage = document.getElementById('resultImage');
    const errorText = document.getElementById('errorText');
    
    const copyIdBtn = document.getElementById('copyIdBtn');
    const fileIdText = document.getElementById('fileIdText');
    const iconCopy = document.getElementById('iconCopy');
    const iconCheck = document.getElementById('iconCheck');
    
    const deleteBtn = document.getElementById('deleteBtn');

    let currentFileId = null;

    // Helpers
    function showState(state) {
      [stateEmpty, stateLoading, stateError, stateSuccess].forEach(el => el.classList.add('hidden'));
      if(state === 'empty') stateEmpty.classList.remove('hidden');
      if(state === 'loading') stateLoading.classList.remove('hidden');
      if(state === 'error') stateError.classList.remove('hidden');
      if(state === 'success') stateSuccess.classList.remove('hidden');
    }

    // --- 1. Xử lý Tạo ảnh ---
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = promptInput.value.trim();
      const model = modelSelect.value;

      if (!prompt) return alert("Vui lòng nhập mô tả ý tưởng của bạn!");

      // UI Loading
      showState('loading');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner" style="width: 18px; height: 18px; border-width: 2px;"></span> Đang xử lý...';

      try {
        const res = await fetch(WEBHOOK_GENERATE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, model })
        });

        if (!res.ok) throw new Error(`Máy chủ không phản hồi (Mã lỗi: ${res.status})`);

        const data = await res.json();

        if (data.url) {
          resultImage.src = data.url;
          currentFileId = data.fileId || "Unknown";
          fileIdText.innerText = currentFileId;
          
          // Reset trạng thái nút copy
          copyIdBtn.classList.remove('copied');
          iconCopy.classList.remove('hidden');
          iconCheck.classList.add('hidden');
          
          showState('success');
        } else {
          throw new Error("Không nhận được dữ liệu hình ảnh.");
        }

      } catch (err) {
        console.error(err);
        errorText.innerText = err.message || "Đã có lỗi xảy ra, vui lòng thử lại.";
        showState('error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg> <span>Bắt đầu tạo ảnh</span>';
      }
    });

    // --- 2. Xử lý Copy ID ---
    copyIdBtn.addEventListener('click', () => {
      if (!currentFileId) return;

      // Kỹ thuật copy an toàn cho mọi trình duyệt (tạo textarea ẩn)
      const textArea = document.createElement("textarea");
      textArea.value = currentFileId;
      document.body.appendChild(textArea);
      textArea.select();
      
      try {
        document.execCommand('copy');
        
        // Hiệu ứng thành công
        copyIdBtn.classList.add('copied');
        iconCopy.classList.add('hidden');
        iconCheck.classList.remove('hidden');
        
        const originalText = fileIdText.innerText;
        fileIdText.innerText = "Đã chép!";
        
        // Reset lại sau 2 giây
        setTimeout(() => {
          copyIdBtn.classList.remove('copied');
          iconCopy.classList.remove('hidden');
          iconCheck.classList.add('hidden');
          fileIdText.innerText = currentFileId;
        }, 2000);
        
      } catch (err) {
        alert('Không thể copy tự động. ID là: ' + currentFileId);
      }
      
      document.body.removeChild(textArea);
    });

    // --- 3. Xử lý Xóa ảnh ---
    deleteBtn.addEventListener('click', async () => {
      if (!currentFileId) return;
      if (!confirm("Bạn có chắc chắn muốn xóa tác phẩm này không?")) return;

      const originalText = deleteBtn.innerText;
      deleteBtn.innerText = "Đang xóa...";
      deleteBtn.disabled = true;

      try {
        const res = await fetch(WEBHOOK_DELETE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            fileId: currentFileId,
            action: 'delete' 
          })
        });

        if (!res.ok) throw new Error("Lỗi kết nối máy chủ");

        alert("Đã xóa thành công!");
        showState('empty');
        promptInput.value = ""; // Reset form
        currentFileId = null;

      } catch (err) {
        alert("Không thể xóa: " + err.message);
      } finally {
        deleteBtn.innerText = originalText;
        deleteBtn.disabled = false;
      }
    });
  </script>

</body>
</html>