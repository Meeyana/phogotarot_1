<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>‚ú® AI Image Generator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* --- CSS Variables & Reset --- */
    :root {
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --primary-color: #4f46e5; /* M√†u t√≠m indigo */
      --primary-hover: #4338ca;
      --danger-color: #ef4444;
      --danger-hover: #dc2626;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-color: #e5e7eb;
      --radius: 12px;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }

    /* --- Main Container --- */
    .ai-gen-container {
      width: 100%;
      max-width: 800px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông ƒë·ªÉ kh√¥ng b·ªã b√® ra */
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Header */
    .header { text-align: center; margin-bottom: 10px; }
    .header h1 { margin: 0 0 8px; font-size: 24px; color: var(--primary-color); }
    .header p { margin: 0; color: var(--text-muted); font-size: 14px; }

    /* Form Elements */
    .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .form-label { font-weight: 600; font-size: 14px; }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      box-sizing: border-box; /* Quan tr·ªçng ƒë·ªÉ padding kh√¥ng l√†m v·ª° layout */
      transition: border-color 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-textarea { resize: vertical; min-height: 120px; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
      gap: 8px;
      width: 100%;
    }

    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-primary:disabled { background-color: #a5a3e6; cursor: not-allowed; }

    .btn-danger { background-color: #fee2e2; color: var(--danger-color); margin-top: 12px; }
    .btn-danger:hover { background-color: #fecaca; }

    /* --- Result Area --- */
    .result-area {
      border-top: 1px solid var(--border-color);
      padding-top: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 200px;
      justify-content: center;
    }

    /* Image Wrapper */
    .image-wrapper {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: #f3f4f6;
      position: relative;
    }

    .image-wrapper img {
      width: 100%;
      height: auto;
      display: block;
      max-height: 500px;
      object-fit: contain;
    }

    /* Placeholder / States */
    .state-msg { text-align: center; color: var(--text-muted); }
    .state-error { color: var(--danger-color); background: #fef2f2; padding: 12px; border-radius: 8px; width: 100%; text-align: center; }

    /* Loading Spinner */
    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Utility */
    .hidden { display: none !important; }
    .meta-info { font-size: 12px; color: var(--text-muted); margin-top: 8px; font-family: monospace; }

    /* Responsive layout for large screens */
    @media (min-width: 768px) {
      .ai-gen-container {
        flex-direction: row;
        align-items: flex-start;
      }
      .col-left, .col-right { flex: 1; width: 100%; }
      .result-area { 
        border-top: none; 
        padding-top: 0; 
        padding-left: 24px; 
        border-left: 1px solid var(--border-color);
        height: 100%;
      }
    }
  </style>
</head>
<body>

  <div class="ai-gen-container">
    
    <!-- C·ªôt tr√°i: Input Form -->
    <div class="col-left">
      <div class="header">
        <h1>AI Image Generator</h1>
        <p>S·ª≠ d·ª•ng Gemini 2.5 & Imagen 4.0</p>
      </div>

      <form id="generateForm">
        <div class="form-group">
          <label class="form-label">M√¥ t·∫£ h√¨nh ·∫£nh (Prompt)</label>
          <textarea id="promptInput" class="form-textarea" placeholder="V√≠ d·ª•: M·ªôt con m√®o m√°y ƒëang u·ªëng c√† ph√™ t·∫°i S√†i G√≤n..." required></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Model AI</label>
          <select id="modelSelect" class="form-select">
            <option value="imagen-4.0-generate-001">Imagen 4.0 (Ch·∫•t l∆∞·ª£ng cao)</option>
            <option value="gemini-2.5-flash-image">Gemini 2.5 Flash (T·ªëc ƒë·ªô nhanh)</option>
          </select>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary">
          <span>‚ú® T·∫°o h√¨nh ·∫£nh</span>
        </button>
      </form>
    </div>

    <!-- C·ªôt ph·∫£i: K·∫øt qu·∫£ -->
    <div class="col-right result-area">
      
      <!-- State: Empty -->
      <div id="stateEmpty" class="state-msg">
        <p>K·∫øt qu·∫£ h√¨nh ·∫£nh s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</p>
      </div>

      <!-- State: Loading -->
      <div id="stateLoading" class="state-msg hidden">
        <div class="spinner" style="margin: 0 auto 10px;"></div>
        <p>ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn n8n...</p>
      </div>

      <!-- State: Error -->
      <div id="stateError" class="state-error hidden">
        <strong>L·ªói:</strong> <span id="errorText">ƒê√£ x·∫£y ra l·ªói</span>
      </div>

      <!-- State: Success -->
      <div id="stateSuccess" class="hidden" style="width: 100%;">
        <div class="image-wrapper">
          <img id="resultImage" src="" alt="AI Generated Image">
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span class="meta-info">ID: <span id="fileIdText">...</span></span>
        </div>

        <button id="deleteBtn" class="btn btn-danger">
          üóëÔ∏è X√≥a h√¨nh & Workflow
        </button>
      </div>

    </div>

  </div>

  <script>
    // --- C·∫§U H√åNH WEBHOOK ---
    const WEBHOOK_GENERATE = "https://n8n.n8ntuanphangz.xyz/webhook/get-prompt";
    const WEBHOOK_DELETE   = "https://n8n.n8ntuanphangz.xyz/webhook/delete-image";

    // Elements
    const form = document.getElementById('generateForm');
    const promptInput = document.getElementById('promptInput');
    const modelSelect = document.getElementById('modelSelect');
    const submitBtn = document.getElementById('submitBtn');
    
    const stateEmpty = document.getElementById('stateEmpty');
    const stateLoading = document.getElementById('stateLoading');
    const stateError = document.getElementById('stateError');
    const stateSuccess = document.getElementById('stateSuccess');
    
    const resultImage = document.getElementById('resultImage');
    const errorText = document.getElementById('errorText');
    const fileIdText = document.getElementById('fileIdText');
    const deleteBtn = document.getElementById('deleteBtn');

    let currentFileId = null;

    // Helpers
    function showState(state) {
      [stateEmpty, stateLoading, stateError, stateSuccess].forEach(el => el.classList.add('hidden'));
      if(state === 'empty') stateEmpty.classList.remove('hidden');
      if(state === 'loading') stateLoading.classList.remove('hidden');
      if(state === 'error') stateError.classList.remove('hidden');
      if(state === 'success') stateSuccess.classList.remove('hidden');
    }

    // --- 1. X·ª≠ l√Ω T·∫°o ·∫£nh ---
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = promptInput.value.trim();
      const model = modelSelect.value;

      if (!prompt) return alert("Vui l√≤ng nh·∫≠p m√¥ t·∫£!");

      // UI Loading
      showState('loading');
      submitBtn.disabled = true;
      submitBtn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";

      try {
        const res = await fetch(WEBHOOK_GENERATE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, model })
        });

        if (!res.ok) throw new Error(`L·ªói k·∫øt n·ªëi: ${res.status}`);

        const data = await res.json();

        // Ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ n8n (c·∫ßn c√≥ field "url" v√† "fileId")
        if (data.url) {
          resultImage.src = data.url;
          currentFileId = data.fileId || "Unknown";
          fileIdText.innerText = currentFileId;
          showState('success');
        } else {
          throw new Error("Kh√¥ng t√¨m th·∫•y URL ·∫£nh trong ph·∫£n h·ªìi.");
        }

      } catch (err) {
        console.error(err);
        errorText.innerText = err.message;
        showState('error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "‚ú® T·∫°o h√¨nh ·∫£nh";
      }
    });

    // --- 2. X·ª≠ l√Ω X√≥a ·∫£nh ---
    deleteBtn.addEventListener('click', async () => {
      if (!currentFileId) return;
      if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a h√¨nh ·∫£nh n√†y?")) return;

      const originalText = deleteBtn.innerText;
      deleteBtn.innerText = "ƒêang x√≥a...";
      deleteBtn.disabled = true;

      try {
        const res = await fetch(WEBHOOK_DELETE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            fileId: currentFileId,
            action: 'delete' 
          })
        });

        if (!res.ok) throw new Error("L·ªói khi g·ªçi webhook x√≥a");

        alert("ƒê√£ x√≥a th√†nh c√¥ng!");
        showState('empty');
        promptInput.value = ""; // Reset form
        currentFileId = null;

      } catch (err) {
        alert("L·ªói x√≥a: " + err.message);
      } finally {
        deleteBtn.innerText = originalText;
        deleteBtn.disabled = false;
      }
    });
  </script>

</body>
</html>