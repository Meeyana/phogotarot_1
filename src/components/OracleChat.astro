---
// src/components/OracleChat.astro
---

<div id="oracle-chat-widget">
  <!-- N√öT M·ªû CHAT -->
  <button id="oracle-toggle-btn" class="oracle-btn" aria-label="Tr√≤ chuy·ªán v·ªõi Joana">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
  </button>

  <!-- Khung Chat -->
  <div id="oracle-chat-box" class="chat-container hidden">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-info">
        <div class="header-avatar">
             <img src="/images/witcher-bot.jpg" alt="Joana Avatar" onerror="this.src='https://ui-avatars.com/api/?name=Joana&background=F2C94C&color=0b132b&size=128'"/>
        </div>
        <div class="header-text">
            <span class="oracle-name">Joana</span>
            <span class="oracle-status">Tarot Reader</span>
        </div>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button id="clear-history-btn" class="icon-btn" title="X√≥a l·ªãch s·ª≠">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </button>
        <button id="close-chat" class="close-btn">&times;</button>
      </div>
    </div>

    <!-- N·ªôi dung tin nh·∫Øn -->
    <div id="chat-messages" class="chat-messages">
      <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c JS load v√†o -->
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
      <textarea id="user-input" placeholder="Nh·∫Øn tin cho Joana..." rows="1"></textarea>
      <button id="send-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
      </button>
    </div>
  </div>
</div>

<style is:global>
  /* --- VARIABLES --- */
  :root {
    --gold-primary: #F2C94C;
    --gold-soft: #fcefc7;
    --bg-dark: #0b132b;
    --bg-panel: rgba(20, 27, 45, 0.95);
    --text-white: #ffffff;
  }

  /* --- WIDGET CONTAINER --- */
  #oracle-chat-widget {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 9999;
    font-family: 'Quicksand', sans-serif;
  }

  /* --- N√öT TR√íN --- */
  .oracle-btn {
    width: 60px; height: 60px;
    border-radius: 50%; padding: 0;
    border: 2px solid var(--gold-primary);
    background: var(--bg-dark); color: var(--gold-primary);
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex; align-items: center; justify-content: center;
  }
  .oracle-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(242, 201, 76, 0.4);
    background: rgba(242, 201, 76, 0.1);
  }

  /* --- CHAT BOX CONTAINER --- */
  .chat-container {
    width: 340px; height: 480px;
    background: var(--bg-panel);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    
    position: absolute; bottom: 80px; right: 0;
    transform-origin: bottom right;
  }

  .chat-container.hidden {
    opacity: 0; transform: scale(0.95) translateY(20px);
    pointer-events: none; visibility: hidden;
  }

  /* --- HEADER --- */
  .chat-header {
    background: rgba(255, 255, 255, 0.03);
    padding: 12px 16px; display: flex;
    justify-content: space-between; align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    /* NgƒÉn header b·ªã co l·∫°i tr√™n mobile */
    flex-shrink: 0; 
  }
  
  .header-info { display: flex; align-items: center; gap: 12px; }
  .header-avatar {
      width: 36px; height: 36px; border-radius: 50%; overflow: hidden;
      border: 1px solid rgba(242, 201, 76, 0.5);
  }
  .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .header-text { display: flex; flex-direction: column; justify-content: center; }
  .oracle-name { color: var(--text-white); font-weight: 700; font-size: 1rem; line-height: 1.2; }
  .oracle-status { font-size: 0.75rem; color: var(--gold-primary); font-weight: 500; }

  .close-btn {
    background: none; border: none; color: #aaa;
    font-size: 24px; cursor: pointer; line-height: 1; padding: 0;
    transition: color 0.2s;
  }
  .close-btn:hover { color: var(--text-white); }
  
  .icon-btn {
    background: none; border: none; color: #aaa;
    cursor: pointer; padding: 5px; display: flex;
    transition: color 0.2s;
  }
  .icon-btn:hover { color: #ff6b6b; }

  /* --- MESSAGES AREA --- */
  .chat-messages {
    flex: 1; padding: 16px;
    overflow-y: auto;
    display: flex; flex-direction: column; gap: 12px;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.2) transparent;
    
    /* [FIX QUAN TR·ªåNG] NgƒÉn scroll chain l√™n body */
    overscroll-behavior: contain; 
    -webkit-overflow-scrolling: touch; /* M∆∞·ª£t m√† tr√™n iOS */
  }
  .chat-messages::-webkit-scrollbar { width: 6px; }
  .chat-messages::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); border-radius: 10px; }

  /* Style tin nh·∫Øn */
  .message {
    max-width: 80%; display: flex; flex-direction: column;
    animation: fadeIn 0.3s ease;
  }
  .message-content {
    padding: 10px 14px; border-radius: 14px;
    font-size: 0.95rem; line-height: 1.5; word-wrap: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .bot-message { align-self: flex-start; }
  .bot-message .message-content { background: rgba(255, 255, 255, 0.1); color: #eee; border-bottom-left-radius: 2px; }
  .user-message { align-self: flex-end; }
  .user-message .message-content { background: var(--gold-primary); color: var(--bg-dark); border-bottom-right-radius: 2px; font-weight: 600; }

  .typing-indicator {
    font-size: 0.8rem; color: #888;
    margin-left: 10px; display: flex; align-items: center; gap: 4px;
    font-style: italic;
  }

  /* --- INPUT AREA --- */
  .chat-input-area {
    padding: 12px; background: rgba(0,0,0,0.2);
    display: flex; gap: 8px; align-items: flex-end;
    border-top: 1px solid rgba(255,255,255,0.05);
    flex-shrink: 0; /* Kh√¥ng cho ph√©p b·ªã co l·∫°i */
  }
  
  textarea {
    flex: 1; background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px; color: white;
    padding: 10px 14px; resize: none;
    font-family: inherit; outline: none;
    font-size: 0.95rem; max-height: 80px;
  }
  textarea:focus { border-color: var(--gold-primary); background: rgba(0,0,0,0.3); }

  #send-btn {
    background: transparent; border: none;
    color: var(--gold-primary);
    width: 36px; height: 36px; border-radius: 50%;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  #send-btn:hover { background: rgba(242, 201, 76, 0.1); }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- MOBILE FULLSCREEN & SAFARI FIXES --- */
  @media (max-width: 600px) {
    .chat-container {
      position: fixed; top: 0; left: 0; bottom: 0;
      /* D√πng width 100% thay v√¨ 100vw ƒë·ªÉ tr√°nh thanh scrollbar l√†m ph√¨nh trang */
      width: 100%; 
      height: 100%; 
      height: 100dvh; /* Dynamic viewport height cho mobile */
      border-radius: 0; margin: 0; z-index: 10000;
      transform: none;
    }

    .chat-container.hidden {
      opacity: 0; transform: translateY(100%);
      pointer-events: none; visibility: hidden;
    }

    .chat-container:not(.hidden) {
      animation: slideUpMobile 0.3s ease-out forwards;
    }

    @keyframes slideUpMobile {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .chat-input-area { padding: 15px; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
    .close-btn { padding: 10px; font-size: 28px; }

    /* [FIX SAFARI ZOOM] B·∫Øt bu·ªôc font-size >= 16px */
    textarea {
        font-size: 16px !important;
    }
  }
</style>

<script>
  // --- CONFIG ---
  const N8N_WEBHOOK_URL = 'https://n8n.n8ntuanphangz.xyz/webhook-test/1edf60a9-32a8-40cf-b9a7-a067487868fd';
  const HISTORY_KEY = 'phogo_tarot_chat_history';
  const SESSION_KEY = 'phogo_tarot_session';
  
  // --- ELEMENTS ---
  const toggleBtn = document.getElementById('oracle-toggle-btn');
  const chatBox = document.getElementById('oracle-chat-box');
  const closeBtn = document.getElementById('close-chat');
  const clearBtn = document.getElementById('clear-history-btn');
  const sendBtn = document.getElementById('send-btn');
  const userInput = document.getElementById('user-input');
  const messagesContainer = document.getElementById('chat-messages');

  let isOpen = false;
  let isThinking = false;
  let isTyping = false; 

  function initChat() {
    loadHistory();
    if (messagesContainer.children.length === 0) {
        addMessage("Ch√†o b·∫°n n√® üëã M√¨nh l√† Joana. H√¥m nay t√¢m tr·∫°ng b·∫°n th·∫ø n√†o? C√≥ chuy·ªán g√¨ mu·ªën k·ªÉ cho m√¨nh nghe h√¥ng?", 'bot', false, false);
    }
  }

  function getSessionId() {
    let sessionId = localStorage.getItem(SESSION_KEY);
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem(SESSION_KEY, sessionId);
    }
    return sessionId;
  }

  function saveToHistory(text, sender) {
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    history.push({ text, sender, timestamp: new Date().toISOString() });
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  }

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    messagesContainer.innerHTML = '';
    history.forEach(msg => {
        addMessage(msg.text, msg.sender, false, false);
    });
    scrollToBottom();
  }

  function clearHistory() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ tr√≤ chuy·ªán kh√¥ng?')) {
        localStorage.removeItem(HISTORY_KEY);
        localStorage.removeItem(SESSION_KEY);
        messagesContainer.innerHTML = '';
        addMessage("Ch√†o b·∫°n n√® üëã M√¨nh l√† Joana. H√¥m nay t√¢m tr·∫°ng b·∫°n th·∫ø n√†o? C√≥ chuy·ªán g√¨ mu·ªën k·ªÉ cho m√¨nh nghe h√¥ng?", 'bot', false, false);
    }
  }

  // --- LOGIC ƒê√ìNG M·ªû CHAT (C√ì KH√ìA SCROLL BODY) ---
  function toggleChat() {
    isOpen = !isOpen;
    if (isOpen) {
      chatBox.classList.remove('hidden');
      userInput.focus();
      scrollToBottom();
      
      // [FIX SCROLL BLEEDING] Kh√≥a scroll c·ªßa trang n·ªÅn khi m·ªü chat tr√™n mobile
      if (window.innerWidth <= 600) {
          document.body.style.overflow = 'hidden';
      }
    } else {
      chatBox.classList.add('hidden');
      // [FIX SCROLL BLEEDING] M·ªü l·∫°i scroll cho trang n·ªÅn
      document.body.style.overflow = '';
    }
  }

  function scrollToBottom() {
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  function addMessage(text, sender, animate = false, save = true) {
    if (!messagesContainer) return;

    if (save) {
        saveToHistory(text, sender);
    }

    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
    
    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');
    msgDiv.appendChild(contentDiv);
    
    messagesContainer.appendChild(msgDiv);

    if (animate && sender === 'bot') {
        isTyping = true;
        let index = 0;
        const speed = 15;

        function typeText() {
            if (index < text.length) {
                const char = text.charAt(index);
                if (char === '\n') {
                    contentDiv.innerHTML += '<br>';
                } else {
                    contentDiv.innerHTML += char;
                }
                index++;
                scrollToBottom();
                setTimeout(typeText, speed);
            } else {
                isTyping = false; 
            }
        }
        typeText();
    } else {
        contentDiv.innerHTML = text.replace(/\n/g, '<br>');
        scrollToBottom();
    }
  }

  function addTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'typing-indicator';
    typingDiv.innerText = 'Joana ƒëang so·∫°n tin...';
    messagesContainer.appendChild(typingDiv);
    scrollToBottom();
  }

  function removeTypingIndicator() {
    const typingDiv = document.getElementById('typing-indicator');
    if (typingDiv) typingDiv.remove();
  }

  async function handleSend() {
    const text = userInput.value.trim();
    if (!text || isThinking || isTyping) return;

    addMessage(text, 'user', false, true);
    userInput.value = '';
    
    isThinking = true;
    addTypingIndicator();

    const sessionId = getSessionId();
    
    try {
      const response = await fetch(N8N_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sessionId: sessionId,
          chatInput: text,
          timestamp: new Date().toISOString()
        })
      });

      if (!response.ok) throw new Error('Network error');

      const data = await response.json();
      removeTypingIndicator();
      
      const botReply = data.output || data.text || "Joana ƒëang b·∫≠n x√≠u, th·ª≠ l·∫°i sau nh√©!";
      
      addMessage(botReply, 'bot', true, true);

    } catch (error) {
      console.error('Error:', error);
      removeTypingIndicator();
      addMessage("M·∫°ng c√≥ v·∫•n ƒë·ªÅ r·ªìi, b·∫°n th·ª≠ l·∫°i sau nha!", 'bot', false, false);
    } finally {
      isThinking = false;
    }
  }

  toggleBtn.addEventListener('click', toggleChat);
  closeBtn.addEventListener('click', toggleChat);
  clearBtn.addEventListener('click', clearHistory);
  sendBtn.addEventListener('click', handleSend);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  initChat();
</script>